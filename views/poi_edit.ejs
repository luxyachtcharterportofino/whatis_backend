<%- include('partials/head') %>
<script src="/js/poi-display-utils.js"></script>
<script src="/js/icon-library.js"></script>

<%
// Helper functions for EJS template
function getCategoryLabel(category) {
  const labels = {
    'monument': { text: 'Monumento', color: 'warning', icon: 'ğŸ›ï¸' },
    'church': { text: 'Chiesa', color: 'primary', icon: 'â›ª' },
    'marina': { text: 'Marina', color: 'primary', icon: 'âš“' },
    'beach': { text: 'Spiaggia', color: 'success', icon: 'ğŸ–ï¸' },
    'biological': { text: 'Biologico', color: 'success', icon: 'ğŸŒ¿' },
    'wreck': { text: 'Relitto', color: 'dark', icon: 'ğŸš¢' },
    'viewpoint': { text: 'Punto panoramico', color: 'info', icon: 'ğŸ“¸' },
    'village': { text: 'Villaggio', color: 'secondary', icon: 'ğŸ˜ï¸' },
    'event': { text: 'Evento', color: 'danger', icon: 'ğŸ‰' },
    'restaurant': { text: 'Ristorante', color: 'danger', icon: 'ğŸ½ï¸' },
    'hotel': { text: 'Hotel', color: 'secondary', icon: 'ğŸ¨' },
    'museum': { text: 'Museo', color: 'info', icon: 'ğŸ–¼ï¸' },
    'park': { text: 'Parco', color: 'success', icon: 'ğŸŒ³' },
    'harbor': { text: 'Porto', color: 'primary', icon: 'ğŸš¢' },
    'lighthouse': { text: 'Faro', color: 'warning', icon: 'ğŸ—¼' },
    'cave': { text: 'Grotta', color: 'secondary', icon: 'â›°ï¸' },
    'mountain': { text: 'Montagna', color: 'dark', icon: 'ğŸ”ï¸' },
    'lake': { text: 'Lago', color: 'info', icon: 'ğŸï¸' },
    'river': { text: 'Fiume', color: 'info', icon: 'ğŸŒŠ' },
    'other': { text: 'Altro', color: 'dark', icon: 'ğŸ“' }
  };
  return labels[category] || labels.other;
}

function getSourceLabel(source) {
  const labels = {
    'manual': { text: 'Manuale', color: 'secondary', icon: 'âœ‹' },
    'AI': { text: 'AI', color: 'success', icon: 'ğŸ§ ' },
    'ai': { text: 'AI', color: 'success', icon: 'ğŸ§ ' },
    'osm': { text: 'OSM', color: 'info', icon: 'ğŸ—ºï¸' },
    'wikipedia': { text: 'Wikipedia', color: 'warning', icon: 'ğŸ“š' },
    'internet': { text: 'Internet', color: 'primary', icon: 'ğŸŒ' }
  };
  return labels[source] || labels.manual;
}
%>

<style>
  .poi-edit-form {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
  }
  
  .form-label {
    color: #17a2b8;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .form-control, .form-select {
    background-color: #2d3748;
    border: 1px solid #4a5568;
    color: #e2e8f0;
    border-radius: 8px;
  }
  
  .form-control:focus, .form-select:focus {
    background-color: #2d3748;
    border-color: #17a2b8;
    color: #e2e8f0;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
  }
  
  .form-control::placeholder {
    color: #a0aec0;
  }
  
  .btn-save {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }
  
  .btn-back {
    background: linear-gradient(135deg, #6c757d, #495057);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
  }
  
  .poi-header {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    color: white;
  }
  
  .category-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-left: 10px;
  }
  
  .section-header {
    color: #17a2b8;
    font-weight: 600;
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #17a2b8;
  }
  
  .coordinate-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .textarea-large {
    min-height: 120px;
  }
  
  /* Icon Selector Styles */
  .icon-selector-container {
    background-color: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .current-icon-display {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .icon-preview-large {
    font-size: 48px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 8px;
    display: inline-block;
    min-width: 70px;
    text-align: center;
  }
  
  .icon-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .icon-modal-content {
    background: #1a1a1a;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #17a2b8;
  }
  
  .icon-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 2px solid #17a2b8;
  }
  
  .icon-modal-header h5 {
    margin: 0;
    color: #17a2b8;
  }
  
  .btn-close-custom {
    background: none;
    border: none;
    color: #e2e8f0;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
  }
  
  .btn-close-custom:hover {
    color: #17a2b8;
  }
  
  .icon-modal-body {
    padding: 1.5rem;
  }
  
  .icon-category-group {
    margin-bottom: 1.5rem;
  }
  
  .icon-category-title {
    color: #17a2b8;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 14px;
  }
  
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 8px;
  }
  
  .icon-option {
    font-size: 32px;
    padding: 10px;
    text-align: center;
    background: #2d3748;
    border: 2px solid #4a5568;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .icon-option:hover {
    background: #17a2b8;
    border-color: #17a2b8;
    transform: scale(1.1);
  }
  
  .icon-option.selected {
    background: #28a745;
    border-color: #28a745;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="poi-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h2 class="mb-0">âœï¸ Modifica POI</h2>
            <p class="mb-0 mt-2">Modifica le informazioni del punto di interesse</p>
          </div>
          <div>
            <span class="category-badge bg-light text-dark">
              <%= poi.category ? getCategoryLabel(poi.category).text : 'Altro' %>
            </span>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="poi-edit-form">
        <form id="poiEditForm">
          <!-- Basic Information -->
          <div class="section-header">ğŸ“ Informazioni Base</div>
          
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="name" class="form-label">Nome POI *</label>
              <input type="text" class="form-control" id="name" name="name" value="<%= poi.name %>" required>
            </div>
            <div class="col-md-4">
              <label for="category" class="form-label">Categoria</label>
              <select class="form-select" id="category" name="category">
                <option value="monument" <%= poi.category === 'monument' ? 'selected' : '' %>>ğŸ›ï¸ Monumento</option>
                <option value="church" <%= poi.category === 'church' ? 'selected' : '' %>>â›ª Chiesa</option>
                <option value="marina" <%= poi.category === 'marina' ? 'selected' : '' %>>âš“ Marina</option>
                <option value="beach" <%= poi.category === 'beach' ? 'selected' : '' %>>ğŸ–ï¸ Spiaggia</option>
                <option value="biological" <%= poi.category === 'biological' ? 'selected' : '' %>>ğŸŒ¿ Biologico</option>
                <option value="wreck" <%= poi.category === 'wreck' ? 'selected' : '' %>>ğŸš¢ Relitto</option>
                <option value="viewpoint" <%= poi.category === 'viewpoint' ? 'selected' : '' %>>ğŸ“¸ Punto panoramico</option>
                <option value="village" <%= poi.category === 'village' ? 'selected' : '' %>>ğŸ˜ï¸ Villaggio</option>
                <option value="event" <%= poi.category === 'event' ? 'selected' : '' %>>ğŸ‰ Evento</option>
                <option value="restaurant" <%= poi.category === 'restaurant' ? 'selected' : '' %>>ğŸ½ï¸ Ristorante</option>
                <option value="hotel" <%= poi.category === 'hotel' ? 'selected' : '' %>>ğŸ¨ Hotel</option>
                <option value="museum" <%= poi.category === 'museum' ? 'selected' : '' %>>ğŸ–¼ï¸ Museo</option>
                <option value="park" <%= poi.category === 'park' ? 'selected' : '' %>>ğŸŒ³ Parco</option>
                <option value="harbor" <%= poi.category === 'harbor' ? 'selected' : '' %>>ğŸš¢ Porto</option>
                <option value="lighthouse" <%= poi.category === 'lighthouse' ? 'selected' : '' %>>ğŸ—¼ Faro</option>
                <option value="cave" <%= poi.category === 'cave' ? 'selected' : '' %>>â›°ï¸ Grotta</option>
                <option value="mountain" <%= poi.category === 'mountain' ? 'selected' : '' %>>ğŸ”ï¸ Montagna</option>
                <option value="lake" <%= poi.category === 'lake' ? 'selected' : '' %>>ğŸï¸ Lago</option>
                <option value="river" <%= poi.category === 'river' ? 'selected' : '' %>>ğŸŒŠ Fiume</option>
                <option value="other" <%= poi.category === 'other' ? 'selected' : '' %>>ğŸ“ Altro</option>
              </select>
            </div>
          </div>
          
          <!-- Icon Selection -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">ğŸ¨ Icona POI (per visualizzazione AR)</label>
              <div class="icon-selector-container">
                <div class="current-icon-display">
                  <span class="form-label">Icona Attuale:</span>
                  <span id="currentIconPreview" class="icon-preview-large">
                    <%= poi.customIcon || poi.arIcon || 'ğŸ“' %>
                  </span>
                  <input type="hidden" id="customIcon" name="customIcon" value="<%= poi.customIcon || '' %>">
                </div>
                
                <div class="mt-3">
                  <button type="button" class="btn btn-info btn-sm" onclick="openIconSelector()">
                    ğŸ¨ Scegli Icona
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" onclick="resetToDefaultIcon()">
                    ğŸ”„ Ripristina Predefinita
                  </button>
                  <small class="text-muted ms-2">
                    Lascia vuoto per usare l'icona predefinita della categoria
                  </small>
                </div>
                
                <!-- Icon Selector Modal -->
                <div id="iconSelectorModal" class="icon-modal" style="display: none;">
                  <div class="icon-modal-content">
                    <div class="icon-modal-header">
                      <h5>ğŸ¨ Seleziona Icona POI</h5>
                      <button type="button" class="btn-close-custom" onclick="closeIconSelector()">âœ•</button>
                    </div>
                    <div class="icon-modal-body">
                      <div id="iconCategories"></div>
                      <div class="mt-3">
                        <label class="form-label">Oppure inserisci emoji personalizzata:</label>
                        <input type="text" id="customEmojiInput" class="form-control" placeholder="Es: ğŸŒŸ" maxlength="2">
                        <button type="button" class="btn btn-primary btn-sm mt-2" onclick="setCustomEmoji()">
                          Usa Questa Emoji
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="source" class="form-label">Fonte</label>
              <select class="form-select" id="source" name="source">
                <option value="manual" <%= poi.source === 'manual' ? 'selected' : '' %>>âœ‹ Manuale</option>
                <option value="ai" <%= poi.source === 'ai' ? 'selected' : '' %>>ğŸ¤– AI</option>
                <option value="osm" <%= poi.source === 'osm' ? 'selected' : '' %>>ğŸŒ Open Data</option>
                <option value="wikipedia" <%= poi.source === 'wikipedia' ? 'selected' : '' %>>ğŸ“š Wikipedia</option>
                <option value="internet" <%= poi.source === 'internet' ? 'selected' : '' %>>ğŸ”— Internet</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="zone" class="form-label">Zona</label>
              <input type="text" class="form-control" id="zone" value="<%= poi.zone ? poi.zone.name : 'N/A' %>" readonly>
            </div>
          </div>

          <!-- Coordinates -->
          <div class="section-header">ğŸ“ Coordinate</div>
          
          <div class="coordinate-inputs mb-3">
            <div>
              <label for="lat" class="form-label">Latitudine *</label>
              <input type="number" class="form-control" id="lat" name="lat" value="<%= poi.lat %>" step="0.000001" required>
            </div>
            <div>
              <label for="lng" class="form-label">Longitudine *</label>
              <input type="number" class="form-control" id="lng" name="lng" value="<%= poi.lng %>" step="0.000001" required>
            </div>
          </div>

          <!-- Content -->
          <div class="section-header">ğŸ“– Contenuto</div>
          
          <div class="mb-3">
            <label for="description" class="form-label">Descrizione Base</label>
            <textarea class="form-control textarea-large" id="description" name="description" placeholder="Inserisci una descrizione del POI..."><%= poi.description || '' %></textarea>
          </div>

          <div class="mb-3">
            <label for="aiSummary" class="form-label">ğŸ§  AI Summary</label>
            <textarea class="form-control textarea-large" id="aiSummary" name="aiSummary" placeholder="Riassunto intelligente generato dall'AI..."><%= poi.extraInfo && poi.extraInfo.aiSummary ? poi.extraInfo.aiSummary : '' %></textarea>
          </div>

          <div class="mb-3">
            <label for="curiosities" class="form-label">ğŸ’¡ CuriositÃ </label>
            <textarea class="form-control textarea-large" id="curiosities" name="curiosities" placeholder="CuriositÃ  e dettagli interessanti..."><%= poi.extraInfo && poi.extraInfo.curiosities ? poi.extraInfo.curiosities : '' %></textarea>
          </div>

          <div class="mb-3">
            <label for="historicalFacts" class="form-label">ğŸ“š Fatti Storici</label>
            <textarea class="form-control textarea-large" id="historicalFacts" name="historicalFacts" placeholder="Fatti storici e contesto..."><%= poi.extraInfo && poi.extraInfo.historicalFacts ? poi.extraInfo.historicalFacts : '' %></textarea>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-3 mt-4">
            <button type="submit" class="btn btn-save text-white">
              ğŸ’¾ Salva modifiche
            </button>
            <a href="/admin/pois" class="btn btn-back text-white text-decoration-none">
              ğŸ”™ Torna alla lista
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- ğŸ§± BOOTSTRAP JS -->
<!-- ============================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.getElementById('poiEditForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
      const response = await fetch(`/admin/poi/update/<%= poi._id %>`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert('âœ… POI aggiornato con successo!');
        window.location.href = '/admin/pois';
      } else {
        alert(`âŒ Errore: ${result.message}`);
      }
    } catch (error) {
      console.error('âŒ Error updating POI:', error);
      alert('âŒ Errore durante il salvataggio');
    }
  });
  
  // ===============================
  // ğŸ¨ ICON SELECTOR FUNCTIONS
  // ===============================
  
  function openIconSelector() {
    const modal = document.getElementById('iconSelectorModal');
    const categoriesContainer = document.getElementById('iconCategories');
    const currentCategory = document.getElementById('category').value;
    
    // Popola le icone suggerite in base alla categoria
    const suggestedIcons = getSuggestedIcons(currentCategory);
    const allGroups = Object.entries(iconLibrary);
    
    let html = '<div class="mb-3"><h6 class="text-warning">â­ Icone Suggerite per questa categoria:</h6><div class="icon-grid">';
    
    suggestedIcons.slice(0, 10).forEach(icon => {
      html += `<div class="icon-option" onclick="selectIcon('${icon}')">${icon}</div>`;
    });
    
    html += '</div></div><hr style="border-color: #4a5568;"><h6 class="text-info mb-3">ğŸ“š Tutte le Icone Disponibili:</h6>';
    
    allGroups.forEach(([key, group]) => {
      html += `
        <div class="icon-category-group">
          <div class="icon-category-title">${group.name}</div>
          <div class="icon-grid">
            ${group.icons.map(icon => `<div class="icon-option" onclick="selectIcon('${icon}')">${icon}</div>`).join('')}
          </div>
        </div>
      `;
    });
    
    categoriesContainer.innerHTML = html;
    modal.style.display = 'flex';
  }
  
  function closeIconSelector() {
    document.getElementById('iconSelectorModal').style.display = 'none';
  }
  
  function selectIcon(icon) {
    document.getElementById('customIcon').value = icon;
    document.getElementById('currentIconPreview').textContent = icon;
    closeIconSelector();
    console.log('âœ… Icona selezionata:', icon);
  }
  
  function resetToDefaultIcon() {
    document.getElementById('customIcon').value = '';
    const category = document.getElementById('category').value;
    const defaultIcon = getDefaultIconForCategory(category);
    document.getElementById('currentIconPreview').textContent = defaultIcon;
    console.log('âœ… Ripristinata icona predefinita:', defaultIcon);
  }
  
  function setCustomEmoji() {
    const customEmoji = document.getElementById('customEmojiInput').value.trim();
    if (customEmoji) {
      selectIcon(customEmoji);
      document.getElementById('customEmojiInput').value = '';
    }
  }
  
  function getDefaultIconForCategory(category) {
    const icons = {
      'monument': 'ğŸ›ï¸',
      'church': 'â›ª',
      'marina': 'âš“',
      'beach': 'ğŸ–ï¸',
      'biological': 'ğŸŒ¿',
      'wreck': 'ğŸš¢',
      'viewpoint': 'ğŸ‘ï¸',
      'village': 'ğŸ˜ï¸',
      'event': 'ğŸ‰',
      'restaurant': 'ğŸ½ï¸',
      'hotel': 'ğŸ¨',
      'museum': 'ğŸ–¼ï¸',
      'park': 'ğŸŒ³',
      'harbor': 'ğŸš¢',
      'lighthouse': 'ğŸ—¼',
      'cave': 'ğŸ•³ï¸',
      'mountain': 'â›°ï¸',
      'lake': 'ğŸï¸',
      'river': 'ğŸŒŠ',
      'other': 'ğŸ“'
    };
    return icons[category] || 'ğŸ“';
  }
  
  // Aggiorna anteprima quando cambia categoria
  document.getElementById('category').addEventListener('change', function() {
    const customIconValue = document.getElementById('customIcon').value;
    if (!customIconValue) {
      // Se non c'Ã¨ icona custom, mostra quella predefinita della nuova categoria
      const defaultIcon = getDefaultIconForCategory(this.value);
      document.getElementById('currentIconPreview').textContent = defaultIcon;
    }
  });
  
  // Chiudi modale con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeIconSelector();
    }
  });
</script>

</body>
</html>
