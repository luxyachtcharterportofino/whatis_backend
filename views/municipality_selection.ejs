<%- include('partials/head') %>
<%- include('partials/navbar') %>

<div class="container mt-4">
  <div class="card bg-primary text-white">
    <div class="card-body">
      <h3 class="mb-4">
        <span class="me-2">üèòÔ∏è</span>
        Selezione Municipio per Ricerca POI
      </h3>
      <p class="mb-0">
        Seleziona un municipio nella zona <strong><%= zone.name %></strong> per avviare la ricerca intelligente di POI.
      </p>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">üìç Municipi Trovati nella Zona</h5>
        </div>
        <div class="card-body">
          <!-- DEBUG: mostra flag direttamente nella pagina (visibile nel sorgente HTML) -->
          <!-- DEBUG START -->
          <% if (typeof includeMarineExtension !== 'undefined') { %>
            <!-- DEBUG: includeMarineExtension = <%= includeMarineExtension %> (type: <%= typeof includeMarineExtension %>) -->
            <!-- DEBUG: includeMarineExtension === true: <%= includeMarineExtension === true %> -->
            <!-- DEBUG: Will show Marine card: <%= includeMarineExtension === true ? 'YES' : 'NO' %> -->
          <% } else { %>
            <!-- DEBUG: includeMarineExtension = undefined -->
            <!-- DEBUG: Will show Marine card: NO (undefined) -->
          <% } %>
          <!-- DEBUG END -->
          
          <% if (municipalities && municipalities.length > 0) { %>
            <div class="row">
              <% municipalities.forEach((municipality, index) => { %>
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h6 class="card-title">
                        <span class="me-2">üèòÔ∏è</span>
                        <%= municipality.name %>
                      </h6>
                      <p class="card-text small text-muted">
                        <strong>Coordinate:</strong> <%= municipality.lat.toFixed(4) %>, <%= municipality.lng.toFixed(4) %>
                      </p>
                      <% if (municipality.population) { %>
                        <p class="card-text small">
                          <strong>Popolazione:</strong> <%= municipality.population %>
                        </p>
                      <% } %>
                      <button 
                        class="btn btn-primary btn-sm w-100" 
                        onclick="selectMunicipality('<%= municipality.name %>', '<%= municipality.lat %>', '<%= municipality.lng %>')"
                      >
                        üîç Cerca POI in <%= municipality.name %>
                      </button>
                    </div>
                  </div>
                </div>
              <% }) %>
              
              <% if (typeof includeMarineExtension !== 'undefined' && includeMarineExtension === true) { %>
                <!-- Estensione Marina - Voce virtuale -->
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card h-100 border-primary">
                    <div class="card-body">
                      <h6 class="card-title text-primary">
                        <span class="me-2">üåä</span>
                        <strong>Mare</strong>
                      </h6>
                      <p class="card-text small text-muted">
                        <strong>Estensione Marina:</strong> Relitti e punti di immersione
                      </p>
                      <p class="card-text small">
                        <strong>Ricerca:</strong> Intera zona selezionata
                      </p>
                      <button 
                        class="btn btn-primary btn-sm w-100" 
                        onclick="selectMarineArea()"
                      >
                        üåä Cerca POI Marini
                      </button>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          <% } else { %>
            <div class="alert alert-warning">
              <h5>‚ö†Ô∏è Nessun Municipio Trovato</h5>
              <p>Non sono stati trovati municipi nella zona selezionata. Verifica che la zona abbia coordinate valide.</p>
              <a href="/admin/map" class="btn btn-secondary">‚Üê Torna alla Mappa</a>
            </div>
          <% } %>
          
          <% if (typeof includeMarineExtension !== 'undefined' && includeMarineExtension === true) { %>
            <!-- Estensione Marina - Voce virtuale (mostra anche se non ci sono municipi) -->
            <div class="row mt-3">
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-primary">
                  <div class="card-body">
                    <h6 class="card-title text-primary">
                      <span class="me-2">üåä</span>
                      <strong>Mare</strong>
                    </h6>
                    <p class="card-text small text-muted">
                      <strong>Estensione Marina:</strong> Relitti e punti di immersione
                    </p>
                    <p class="card-text small">
                      <strong>Ricerca:</strong> Intera zona selezionata
                    </p>
                    <button 
                      class="btn btn-primary btn-sm w-100" 
                      onclick="selectMarineArea()"
                    >
                      üåä Cerca POI Marini
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Modal -->
  <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">üîç Ricerca POI in Corso</h5>
        </div>
        <div class="modal-body">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 id="progressBar" 
                 style="width: 0%">
            </div>
          </div>
          <div id="progressMessage" class="text-center">
            Inizializzazione ricerca...
          </div>
          <div id="progressDetails" class="text-muted small mt-2">
            <!-- Dettagli aggiuntivi -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">‚úÖ POI Trovati</h5>
        </div>
        <div class="modal-body">
          <div id="poiResults">
            <!-- Risultati POI -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          <button type="button" class="btn btn-success" id="savePOIsBtn">üíæ Salva POI</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Statistiche POI - Animazioni e highlight */
  .stat-counter {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    transition: background-color 1s ease-out;
    display: inline-block;
  }
  
  .stat-counter.highlight {
    animation: highlightFade 1s ease-out;
  }
  
  .stat-new.highlight {
    background-color: rgba(40, 167, 69, 0.2); /* Light green */
  }
  
  .stat-existing.highlight {
    background-color: rgba(255, 193, 7, 0.2); /* Light yellow */
  }
  
  .stat-ignored.highlight {
    background-color: rgba(108, 117, 125, 0.2); /* Light gray */
  }
  
  .stat-replaced.highlight {
    background-color: rgba(0, 123, 255, 0.2); /* Light blue */
  }
  
  @keyframes highlightFade {
    0% {
      background-color: rgba(255, 255, 255, 0.3);
    }
    100% {
      background-color: transparent;
    }
  }
  
  #poiStatsBar.pulse {
    animation: pulseStatsBar 0.5s ease-out;
  }
  
  @keyframes pulseStatsBar {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.02);
    }
  }
  
  #countNew, #countExisting, #countIgnored, #countReplaced, #countTotal {
    display: inline-block;
    min-width: 1.5em;
    text-align: right;
  }
</style>

<script>
// Dati della zona
const zoneData = <%- JSON.stringify(zone) %>;
const dbFlag = <%= typeof includeMarineExtension !== 'undefined' ? (includeMarineExtension === true ? 'true' : 'false') : 'false' %>;

// CONTROLLA TOGGLE GLOBALE: Se "Estensione Marina" √® attiva nell'interfaccia, forza a true (funziona per TUTTE le zone)
const globalToggle = localStorage.getItem('marineExtensionEnabled') === 'true';
const includeMarineExtension = globalToggle || (dbFlag === 'true' || dbFlag === true);

// Debug: verifica flag (controlla anche nel zoneData)
console.log('[MUNICIPALITY] ===== DEBUG FLAG START =====');
console.log('[MUNICIPALITY] Zone data:', zoneData);
console.log('[MUNICIPALITY] includeMarineExtension from EJS variable:', includeMarineExtension, '(type:', typeof includeMarineExtension, ')');
console.log('[MUNICIPALITY] includeMarineExtension from zoneData:', zoneData.includeMarineExtension, '(type:', typeof zoneData.includeMarineExtension, ')');
console.log('[MUNICIPALITY] includeMarineExtension === "true":', includeMarineExtension === 'true');
console.log('[MUNICIPALITY] includeMarineExtension === true:', includeMarineExtension === true);
console.log('[MUNICIPALITY] Should show Marine option:', includeMarineExtension === 'true' || includeMarineExtension === true);
console.log('[MUNICIPALITY] ===== DEBUG FLAG END =====');

// Alert temporaneo per debug (rimuovere dopo verifica)
<% if (typeof includeMarineExtension !== 'undefined') { %>
  console.log('[MUNICIPALITY] ALERT: includeMarineExtension received in view:', <%= includeMarineExtension ? 'true' : 'false' %>);
<% } else { %>
  console.warn('[MUNICIPALITY] ALERT: includeMarineExtension is UNDEFINED in view!');
<% } %>

let currentMunicipality = null;
let foundPOIs = [];
let existingPOIs = [];
let duplicateMap = new Map(); // Maps new POI index to existing POI data
let stats = {
  new: 0,
  existing: 0,
  ignored: 0,
  replaced: 0
};

// Carica POI esistenti nella zona
async function loadExistingPOIs() {
  try {
    const response = await fetch(`/pois?format=json&zone=${zoneData._id}`);
    if (response.ok) {
      existingPOIs = await response.json();
      console.log(`[DEDUP] Caricati ${existingPOIs.length} POI esistenti nella zona`);
    }
  } catch (error) {
    console.error('[DEDUP] Errore caricamento POI esistenti:', error);
    existingPOIs = [];
  }
}

// Normalizza nome per confronto (rimuove accenti, case-insensitive)
function normalizeName(name) {
  if (!name) return '';
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Rimuove accenti
    .trim();
}

// Calcola distanza Haversine tra due punti (in km)
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // Raggio della Terra in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// Rileva duplicati: nome simile o coordinate vicine (< 200m)
function detectDuplicates(newPOIs) {
  duplicateMap.clear();
  
  newPOIs.forEach((newPOI, index) => {
    if (!newPOI.lat || !newPOI.lng || !newPOI.name) return;
    
    const normalizedNewName = normalizeName(newPOI.name);
    
    for (const existingPOI of existingPOIs) {
      // Controllo nome simile (case-insensitive, accent-insensitive)
      const normalizedExistingName = normalizeName(existingPOI.name);
      const nameSimilar = normalizedNewName === normalizedExistingName ||
        normalizedNewName.includes(normalizedExistingName) ||
        normalizedExistingName.includes(normalizedNewName);
      
      // Controllo coordinate vicine (< 0.2 km = 200 metri)
      const distance = haversineDistance(
        newPOI.lat, newPOI.lng,
        existingPOI.lat, existingPOI.lng
      );
      const closeCoordinates = distance < 0.2;
      
      if (nameSimilar || closeCoordinates) {
        duplicateMap.set(index, existingPOI);
        console.log(`[DEDUP] Duplicato rilevato: "${newPOI.name}" - Match: ${nameSimilar ? 'nome' : 'coordinate'} (${distance.toFixed(3)} km)`);
        break; // Un match √® sufficiente
      }
    }
  });
  
  return duplicateMap.size;
}

// Selezione municipio
function selectMunicipality(name, lat, lng) {
  currentMunicipality = { name, lat: parseFloat(lat), lng: parseFloat(lng) };
  
  // Mostra modal di progresso
  const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
  progressModal.show();
  
  // Avvia ricerca POI
  searchPOIsForMunicipality();
}

// Selezione estensione marina
async function selectMarineArea() {
  // Imposta currentMunicipality come "Mare" per la visualizzazione
  currentMunicipality = { name: 'Mare', lat: null, lng: null, isMarine: true };
  console.log(`[MARINE] Estensione marina selezionata per zona: ${zoneData.name}`);
  
  // Mostra modal progresso
  const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
  progressModal.show();
  
  try {
    updateProgress(10, 'Preparazione ricerca marina...');
    
    // Estrai coordinate della zona
    let zoneCoordinates = zoneData.coordinates;
    if (!zoneCoordinates || !Array.isArray(zoneCoordinates) || zoneCoordinates.length < 3) {
      throw new Error('Coordinate zona non valide');
    }
    
    // Normalizza coordinate (gestisce diversi formati GeoJSON)
    if (Array.isArray(zoneCoordinates[0]) && Array.isArray(zoneCoordinates[0][0]) && Array.isArray(zoneCoordinates[0][0][0])) {
      zoneCoordinates = zoneCoordinates[0][0]; // GeoJSON triple nested
    } else if (Array.isArray(zoneCoordinates[0]) && Array.isArray(zoneCoordinates[0][0]) && typeof zoneCoordinates[0][0][0] === 'number') {
      zoneCoordinates = zoneCoordinates[0]; // Double nested
    }
    
    // Verifica che le coordinate siano valide
    const validCoords = zoneCoordinates.filter(coord => 
      Array.isArray(coord) && coord.length === 2 && 
      !isNaN(coord[0]) && !isNaN(coord[1])
    );
    
    if (validCoords.length < 3) {
      throw new Error('Coordinate zona insufficienti o non valide');
    }
    
    // Formato coordinate per il backend: [[lat, lng], ...]
    const polygon = validCoords.map(coord => [coord[0], coord[1]]);
    
    updateProgress(30, 'Ricerca semantica marina in corso...');
    
    const modeSelect = document.getElementById('semanticModeSelect');
    const semanticMode = (modeSelect ? modeSelect.value : 'standard').toLowerCase();

    // Chiama ricerca semantica con estensione marina sull'intera zona
    const response = await fetch('/admin/semantic/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        zoneName: zoneData.name,
        polygon: polygon,
        extendMarine: true,
        enableAI: true,
        marineOnly: true,
        mode: semanticMode
      })
    });
    
    if (!response.ok) {
      throw new Error('Errore durante la ricerca semantica marina');
    }
    
    const data = await response.json();
    
    if (!data.success || !data.results) {
      throw new Error(data.error || 'Errore durante la ricerca semantica marina');
    }
    
    updateProgress(70, 'Elaborazione POI marini...');
    
    // Estrai POI dai risultati semantici
    // I POI marini possono essere in results.pois o results.marine_pois o results.unique_pois
    let marinePOIs = [];
    
    if (data.results.pois && Array.isArray(data.results.pois)) {
      marinePOIs = data.results.pois;
    } else if (data.results.marine_pois && Array.isArray(data.results.marine_pois)) {
      marinePOIs = data.results.marine_pois;
    } else if (data.results.unique_pois && Array.isArray(data.results.unique_pois)) {
      marinePOIs = data.results.unique_pois;
    }
    
    // Carica POI esistenti per rilevamento duplicati
    await loadExistingPOIs();
    updateProgress(80, 'Analisi duplicati...');
    
    // Marca tutti i POI come marini per distinguerli nella visualizzazione
    marinePOIs = marinePOIs.map(poi => ({
      ...poi,
      isMarine: true,
      category: poi.category || 'wreck'
    }));
    
    foundPOIs = marinePOIs;
    
    // Rileva duplicati
    const duplicateCount = detectDuplicates(foundPOIs);
    console.log(`[DEDUP] Rilevati ${duplicateCount} duplicati su ${foundPOIs.length} POI marini`);
    
    // Inizializza statistiche
    stats.new = foundPOIs.length - duplicateCount;
    stats.existing = duplicateCount;
    stats.ignored = 0;
    stats.replaced = 0;
    
    updateProgress(100, 'Ricerca marina completata!');
    
    // Chiudi modal progresso
    const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    progressModal.hide();
    
    // Mostra risultati
    showPOIResults();
    
  } catch (error) {
    console.error('Errore ricerca marina:', error);
    updateProgress(0, 'Errore durante la ricerca');
    alert('Errore durante la ricerca POI marini: ' + error.message);
    
    // Chiudi modal progresso
    const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    progressModal.hide();
  }
}

// Ricerca POI per municipio
async function searchPOIsForMunicipality() {
  try {
    updateProgress(0, 'Inizializzazione ricerca...');
    
    // Carica POI esistenti per rilevamento duplicati
    await loadExistingPOIs();
    updateProgress(20, 'Caricamento POI esistenti...');
    
    const response = await fetch('/admin/pois/search-municipality', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        municipality: currentMunicipality,
        zone: zoneData
      })
    });
    
    if (!response.ok) {
      throw new Error('Errore durante la ricerca POI');
    }
    
    const data = await response.json();
    
    if (data.success) {
      foundPOIs = data.pois;
      updateProgress(80, 'Analisi duplicati...');
      
      // Rileva duplicati
      const duplicateCount = detectDuplicates(foundPOIs);
      console.log(`[DEDUP] Rilevati ${duplicateCount} duplicati su ${foundPOIs.length} POI`);
      
      // Inizializza statistiche
      stats.new = foundPOIs.length - duplicateCount;
      stats.existing = duplicateCount;
      stats.ignored = 0;
      stats.replaced = 0;
      
      updateProgress(100, 'Ricerca completata!');
      
      // Chiudi modal progresso
      const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
      progressModal.hide();
      
      // Mostra risultati
      showPOIResults();
    } else {
      throw new Error(data.message || 'Errore durante la ricerca');
    }
    
  } catch (error) {
    console.error('Errore ricerca POI:', error);
    updateProgress(0, 'Errore durante la ricerca');
    alert('Errore durante la ricerca POI: ' + error.message);
  }
}

// Mostra risultati POI con rilevamento duplicati
function showPOIResults() {
  const resultsContainer = document.getElementById('poiResults');
  
  if (foundPOIs.length === 0) {
    const searchTarget = currentMunicipality?.isMarine ? 'l\'Estensione Marina' : `il municipio <strong>${currentMunicipality?.name || 'selezionato'}</strong>`;
    resultsContainer.innerHTML = `
      <div class="alert alert-info">
        <h5>‚ÑπÔ∏è Nessun POI Trovato</h5>
        <p>Non sono stati trovati POI per ${currentMunicipality?.isMarine ? '<strong>l\'Estensione Marina</strong>' : searchTarget}.</p>
      </div>
    `;
  } else {
    // Calcola valori iniziali escludendo POI ignorati/sostituiti
    const visiblePOIs = foundPOIs.filter(poi => !poi._ignored && !poi._replaced);
    const visibleDuplicateIndices = Array.from(duplicateMap.keys()).filter(i => !foundPOIs[i]?._ignored && !foundPOIs[i]?._replaced);
    const newCount = visiblePOIs.length - visibleDuplicateIndices.length;
    const duplicateCount = visibleDuplicateIndices.length;
    
    // Inizializza statistiche se non ancora fatto
    if (stats.new === 0 && stats.existing === 0) {
      stats.new = newCount;
      stats.existing = duplicateCount;
      stats.ignored = 0;
      stats.replaced = 0;
    }
    
    resultsContainer.innerHTML = `
      <div class="alert alert-success" id="poiStatsBar">
        <h5>‚úÖ <span id="countTotal">${visiblePOIs.length}</span> POI Trovati</h5>
        <div class="d-flex flex-wrap align-items-center gap-3 mt-2" id="poiStatsCounters">
          <span class="stat-counter stat-new" id="statNew">
            üü¢ <strong><span id="countNew">${stats.new}</span> nuovi</strong>
          </span>
          <span class="stat-counter stat-existing" id="statExisting">
            ‚ö†Ô∏è <strong><span id="countExisting">${stats.existing}</span> esistenti</strong>
          </span>
          <span class="stat-counter stat-ignored" id="statIgnored" style="display: ${stats.ignored > 0 ? 'inline-block' : 'none'};">
            ‚è≠Ô∏è <strong><span id="countIgnored">${stats.ignored}</span> ignorati</strong>
          </span>
          <span class="stat-counter stat-replaced" id="statReplaced" style="display: ${stats.replaced > 0 ? 'inline-block' : 'none'};">
            üîÑ <strong><span id="countReplaced">${stats.replaced}</span> sostituiti</strong>
          </span>
          <span class="text-muted">‚Äî per <strong>${currentMunicipality?.isMarine ? 'üåä Estensione Marina' : (currentMunicipality?.name || 'zona selezionata')}</strong></span>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="poiResultsTable">
          <thead>
            <tr>
              <th>Stato</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Descrizione</th>
              <th>Coordinate</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            ${foundPOIs.map((poi, index) => {
              // Skip POI ignorati o sostituiti
              if (poi._ignored || poi._replaced) return '';
              
              const isDuplicate = duplicateMap.has(index);
              const existingPOI = duplicateMap.get(index);
              const rowId = `poi-row-${index}`;
              
              return `
              <tr id="${rowId}" ${isDuplicate ? 'class="table-warning"' : ''}>
                <td>
                  ${isDuplicate 
                    ? '<span class="badge bg-warning text-dark">‚ö†Ô∏è Esistente</span>' 
                    : '<span class="badge bg-success">üü¢ Nuovo</span>'}
                </td>
                <td>
                  ${poi.isMarine || poi.category === 'wreck' || poi.category === 'marina' || poi.category === 'harbor' || poi.category === 'lighthouse'
                    ? `<strong class="text-primary">${poi.name}</strong>`
                    : `<strong>${poi.name}</strong>`}
                  ${poi.customIcon ? `<span class="ms-2">${poi.customIcon}</span>` : ''}
                  ${isDuplicate ? `<br><small class="text-muted">Esiste gi√†: "${existingPOI.name}"</small>` : ''}
                </td>
                <td>
                  <span class="badge bg-primary">${poi.category || 'N/A'}</span>
                </td>
                <td>
                  <small>${poi.description ? poi.description.substring(0, 100) + '...' : 'Nessuna descrizione'}</small>
                </td>
                <td>
                  <small>${poi.lat.toFixed(4)}, ${poi.lng.toFixed(4)}</small>
                </td>
                <td>
                  ${isDuplicate ? `
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-warning" onclick="replacePOI(${index})" title="Sostituisci POI esistente">
                        üîÑ Sostituisci
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="ignorePOI(${index})" title="Ignora questo POI">
                        ‚è≠Ô∏è Ignora
                      </button>
                    </div>
                  ` : ''}
                </td>
              </tr>
            `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  // Mostra modal risultati
  const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
  resultsModal.show();
  
  // Aggiorna statistiche con animazioni dopo un breve delay per assicurare che gli elementi siano nel DOM
  setTimeout(() => {
    updatePOIStats();
  }, 100);
}

// Ignora POI (rimuove dalla lista temporanea)
function ignorePOI(index) {
  const poiName = foundPOIs[index]?.name || 'POI sconosciuto';
  const row = document.getElementById(`poi-row-${index}`);
  
  if (!row || !foundPOIs[index]) return;
  
  // Marca POI come ignorato
  foundPOIs[index]._ignored = true;
  
  // Aggiorna statistiche prima di rimuovere dalla DOM
  const wasDuplicate = duplicateMap.has(index);
  if (wasDuplicate) {
    // Era un duplicato esistente
    stats.existing = Math.max(0, stats.existing - 1);
  } else {
    // Era un nuovo POI
    stats.new = Math.max(0, stats.new - 1);
  }
  stats.ignored++;
  
  // Fade out e rimuovi dalla DOM
  row.style.transition = 'opacity 0.3s ease-out';
  row.style.opacity = '0';
  setTimeout(() => {
    row.remove();
    
    // Rimuovi dal duplicateMap
    duplicateMap.delete(index);
    
    console.log(`[DEDUP] POI ignorato: ${poiName} (rimosso dalla lista temporanea)`);
    
    // Aggiorna statistiche con animazioni
    updatePOIStats();
  }, 300);
}

// Sostituisci POI esistente
async function replacePOI(index) {
  const newPOI = foundPOIs[index];
  const existingPOI = duplicateMap.get(index);
  
  if (!existingPOI || !existingPOI._id) {
    alert('Errore: POI esistente non trovato');
    return;
  }
  
  try {
    // Mostra loading
    const row = document.getElementById(`poi-row-${index}`);
    if (row) {
      const actionsCell = row.querySelector('td:last-child');
      if (actionsCell) {
        actionsCell.innerHTML = '<span class="text-info">üîÑ Aggiornamento...</span>';
      }
    }
    
    // Aggiorna POI esistente con nuovi dati
    const response = await fetch(`/pois/${existingPOI._id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: newPOI.name,
        description: newPOI.description || '',
        lat: newPOI.lat,
        lng: newPOI.lng,
        category: newPOI.category || 'other',
        source: newPOI.source || 'AI',
        imageUrl: newPOI.imageUrl || '',
        zone: zoneData._id
      })
    });
    
    if (!response.ok) {
      throw new Error('Errore durante l\'aggiornamento del POI');
    }
    
    const data = await response.json();
    
    if (data.success) {
      console.log(`[DEDUP] POI sostituito: ${newPOI.name} (aggiornato POI esistente ${existingPOI._id})`);
      
      // Marca POI come sostituito
      foundPOIs[index]._replaced = true;
      
      // Aggiorna statistiche
      stats.existing = Math.max(0, stats.existing - 1);
      stats.replaced++;
      
      // Rimuovi dalla lista temporanea (stesso comportamento di Ignora)
      const row = document.getElementById(`poi-row-${index}`);
      if (row) {
        row.style.transition = 'opacity 0.3s ease-out';
        row.style.opacity = '0';
        setTimeout(() => {
          row.remove();
          duplicateMap.delete(index);
          // Aggiorna statistiche con animazioni
          updatePOIStats();
        }, 300);
      }
      
      // Aggiorna lista POI esistenti per evitare nuovi duplicati
      await loadExistingPOIs();
      
      alert(`‚úÖ POI "${newPOI.name}" sostituito con successo!`);
    } else {
      throw new Error(data.message || 'Errore durante la sostituzione');
    }
    
  } catch (error) {
    console.error('[DEDUP] Errore sostituzione POI:', error);
    alert('Errore durante la sostituzione: ' + error.message);
    
    // Ripristina pulsanti
    const row = document.getElementById(`poi-row-${index}`);
    if (row) {
      const actionsCell = row.querySelector('td:last-child');
      if (actionsCell) {
        actionsCell.innerHTML = `
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-warning" onclick="replacePOI(${index})">üîÑ Sostituisci</button>
            <button type="button" class="btn btn-secondary" onclick="ignorePOI(${index})">‚è≠Ô∏è Ignora</button>
          </div>
        `;
      }
    }
  }
}

// Animazione count-up per numeri
function countUp(elementId, targetValue, highlightElementId = null) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const startValue = parseInt(element.textContent) || 0;
  const diff = targetValue - startValue;
  
  if (diff === 0) return; // Nessun cambiamento
  
  const duration = 500; // ms
  const fps = 30;
  const frames = Math.ceil(duration / (1000 / fps));
  const increment = diff / frames;
  let currentValue = startValue;
  let frame = 0;
  
  // Highlight element se fornito
  if (highlightElementId) {
    const highlightElement = document.getElementById(highlightElementId);
    if (highlightElement) {
      highlightElement.classList.add('highlight');
      setTimeout(() => {
        highlightElement.classList.remove('highlight');
      }, 1000);
    }
  }
  
  // Pulse stats bar se il totale diminuisce
  if (elementId === 'countTotal' || elementId === 'countNew' || elementId === 'countExisting') {
    if (diff < 0) {
      const statsBar = document.getElementById('poiStatsBar');
      if (statsBar) {
        statsBar.classList.add('pulse');
        setTimeout(() => {
          statsBar.classList.remove('pulse');
        }, 500);
      }
    }
  }
  
  // Anima il valore
  const animate = () => {
    frame++;
    currentValue += increment;
    
    if (frame >= frames || (diff > 0 && currentValue >= targetValue) || (diff < 0 && currentValue <= targetValue)) {
      element.textContent = targetValue;
      return;
    }
    
    // Arrotonda e aggiorna
    element.textContent = Math.round(currentValue);
    requestAnimationFrame(animate);
  };
  
  requestAnimationFrame(animate);
}

// Aggiorna statistiche POI con animazioni
function updatePOIStats() {
  // Calcola valori dai POI visibili nella tabella
  const visibleRows = document.querySelectorAll('#poiResultsTable tbody tr').length;
  const duplicateRows = document.querySelectorAll('#poiResultsTable tbody tr.table-warning').length;
  const newRows = visibleRows - duplicateRows;
  
  // Calcola valori finali
  const totalVisible = visibleRows;
  const totalNew = Math.max(0, newRows);
  const totalExisting = Math.max(0, duplicateRows);
  const totalIgnored = stats.ignored || 0;
  const totalReplaced = stats.replaced || 0;
  
  // Sincronizza stats object per nuovi ed esistenti (basati sulla tabella)
  stats.new = totalNew;
  stats.existing = totalExisting;
  
  // Anima i contatori se cambiano
  countUp('countTotal', totalVisible);
  countUp('countNew', totalNew, 'statNew');
  countUp('countExisting', totalExisting, 'statExisting');
  countUp('countIgnored', totalIgnored, 'statIgnored');
  countUp('countReplaced', totalReplaced, 'statReplaced');
  
  // Mostra/nascondi contatori ignorati e sostituiti
  const statIgnored = document.getElementById('statIgnored');
  const statReplaced = document.getElementById('statReplaced');
  
  if (statIgnored) {
    if (totalIgnored > 0) {
      statIgnored.style.display = 'inline-block';
    } else {
      statIgnored.style.display = 'none';
    }
  }
  
  if (statReplaced) {
    if (totalReplaced > 0) {
      statReplaced.style.display = 'inline-block';
    } else {
      statReplaced.style.display = 'none';
    }
  }
}

// Salva POI (esclude quelli ignorati)
document.getElementById('savePOIsBtn').addEventListener('click', async function() {
  try {
    this.disabled = true;
    this.textContent = 'üíæ Salvando...';
    
    // Filtra POI ignorati e quelli gi√† sostituiti
    const poisToSave = foundPOIs.filter(poi => !poi._ignored && !poi._replaced);
    
    console.log(`[DEDUP] Salvataggio: ${poisToSave.length} POI (${foundPOIs.length - poisToSave.length} ignorati/sostituiti)`);
    
    if (poisToSave.length === 0) {
      alert('‚ö†Ô∏è Nessun POI da salvare. Tutti i POI sono stati ignorati o sostituiti.');
      this.disabled = false;
      this.textContent = 'üíæ Salva POI';
      return;
    }
    
    const response = await fetch('/admin/pois/save-municipality-pois', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        pois: poisToSave,
        municipality: currentMunicipality,
        zone: zoneData
      })
    });
    
    if (!response.ok) {
      throw new Error('Errore durante il salvataggio');
    }
    
    const data = await response.json();
    
    if (data.success) {
      alert(`‚úÖ ${data.savedCount} POI salvati con successo!`);
      window.location.href = '/admin/pois';
    } else {
      throw new Error(data.message || 'Errore durante il salvataggio');
    }
    
  } catch (error) {
    console.error('Errore salvataggio POI:', error);
    alert('Errore durante il salvataggio: ' + error.message);
  } finally {
    this.disabled = false;
    this.textContent = 'üíæ Salva POI';
  }
});

// Aggiorna progresso
function updateProgress(percentage, message, details = '') {
  const progressBar = document.getElementById('progressBar');
  const progressMessage = document.getElementById('progressMessage');
  const progressDetails = document.getElementById('progressDetails');
  
  progressBar.style.width = percentage + '%';
  progressBar.textContent = percentage + '%';
  progressMessage.textContent = message;
  progressDetails.textContent = details;
}
</script>
