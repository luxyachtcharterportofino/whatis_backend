<%- include('partials/head') %>
<body class="bg-dark text-light">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-black shadow-sm px-4">
    <a class="navbar-brand" href="/admin/dashboard" aria-label="Whatis dashboard">
        <img
          src="/images/whatis-logo-white.svg"
          alt="Whatis Explorer"
          style="height: 80px; width: auto; filter: drop-shadow(0 2px 6px rgba(255, 255, 255, 0.4));"
        />
    </a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link text-light" href="/admin/dashboard">Dashboard</a>
      <a class="nav-link text-light" href="/admin/zones">Zone</a>
      <a class="nav-link text-light" href="/admin/pois">POI</a>
      <a class="nav-link text-light" href="/admin/map">Cartina</a>
    </div>
  </nav>
  
  <!-- Bootstrap JS per tooltip (se non gi√† incluso nel footer) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <div class="container mt-4">
    <h4 class="text-info mb-3">üìç Elenco Zone</h4>
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Descrizione</th>
          <th>Coordinate</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        <% zones.forEach(z => { %>
          <tr>
            <td><%= z.name %></td>
            <td><%= z.description || "-" %></td>
            <td><%= (z.coordinates || []).length %> punti geom. / <%= z.poiCount || 0 %> POI</td>
            <td>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-warning btn-sm" onclick='editZone("<%= z._id %>")'>‚úèÔ∏è Modifica</button>
                <button type="button" class="btn btn-success btn-sm" onclick='generatePOIs("<%= z._id %>", "<%= z.name %>")'>üöÄ Genera POI</button>
                <form action="/zones/<%= z._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Eliminare la zona "<%= z.name %>"?')" style="display: inline;">
                  <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Elimina</button>
                </form>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <a href="/admin/map" class="btn btn-info mt-3">üåç Torna alla Mappa</a>
  </div>

  <script>
    function editZone(zoneId) {
      // Redirect to map with edit mode
      window.location.href = `/admin/map?editZone=${zoneId}`;
    }

    function generatePOIs(zoneId, zoneName) {
      // Apri modale per generazione POI
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'generatePOIModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
              <h5 class="modal-title">üöÄ Genera POI per "${zoneName}"</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <!-- Info Box -->
              <div class="alert alert-info mb-4" role="alert">
                <h6 class="alert-heading">‚ÑπÔ∏è Come funziona la generazione POI</h6>
                <p class="mb-2 small">Questa √® l'unica interfaccia per generare POI con GPT-4o. Il sistema esegue automaticamente:</p>
                <ol class="mb-0 small">
                  <li><strong>Generazione</strong> - GPT-4o trova i POI basandosi su Zona + Comune con prompt intelligenti</li>
                  <li><strong>Geocoding</strong> - Trova coordinate precise con fallback multipli (Nominatim ‚Üí Google ‚Üí Wikidata)</li>
                  <li><strong>Validazione</strong> - Verifica che i POI siano nella zona corretta</li>
                  <li><strong>Revisione</strong> - Pagina interattiva per correggere e salvare i POI</li>
                </ol>
                <p class="mb-0 small mt-2"><strong>Nota:</strong> Richiede OPENAI_API_KEY configurata nel backend.</p>
              </div>

              <div class="mb-3">
                <label class="form-label">
                  Zona
                  <span class="badge bg-secondary ms-2">Preselezionata</span>
                </label>
                <input type="text" class="form-control bg-dark text-light border-secondary" value="${zoneName}" disabled>
                <small class="text-muted">La zona √® gi√† selezionata dalla pagina corrente</small>
              </div>

              <div class="mb-3">
                <label class="form-label">
                  Comune <span class="text-danger">*</span>
                  <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Il comune viene incluso nel prompt per Perplexity per ottenere risultati pi√π precisi e contestualizzati"></i>
                </label>
                <select id="municipality" class="form-select bg-dark text-light border-secondary" required>
                  <option value="">-- Seleziona Comune --</option>
                  <option value="Portofino">Portofino</option>
                  <option value="Santa Margherita Ligure">Santa Margherita Ligure</option>
                  <option value="Rapallo">Rapallo</option>
                  <option value="Camogli">Camogli</option>
                  <option value="Chiavari">Chiavari</option>
                  <option value="Lavagna">Lavagna</option>
                  <option value="Sestri Levante">Sestri Levante</option>
                  <option value="Moneglia">Moneglia</option>
                  <option value="Deiva Marina">Deiva Marina</option>
                  <option value="Framura">Framura</option>
                  <option value="Bonassola">Bonassola</option>
                  <option value="Levanto">Levanto</option>
                  <option value="Monterosso al Mare">Monterosso al Mare</option>
                  <option value="Vernazza">Vernazza</option>
                  <option value="Corniglia">Corniglia</option>
                  <option value="Manarola">Manarola</option>
                  <option value="Riomaggiore">Riomaggiore</option>
                  <option value="La Spezia">La Spezia</option>
                </select>
                <small class="text-muted">Il comune viene incluso nel prompt per migliorare la precisione della ricerca</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Tipo di POI</label>
                <select id="poiType" class="form-select bg-dark text-light border-secondary">
                  <option value="both">Terrestri e Marini</option>
                  <option value="terrestrial">Solo Terrestri</option>
                  <option value="marine">Solo Marini</option>
                </select>
                <small class="text-muted">I POI marini vengono generati solo se la zona ha l'estensione marina abilitata</small>
              </div>

              <div class="mb-3">
                <label class="form-label">
                  Prompt Personalizzato <span class="badge bg-secondary">Opzionale</span>
                </label>
                <textarea id="customPrompt" class="form-control bg-dark text-light border-secondary" rows="4" 
                  placeholder="Lascia vuoto per usare il prompt automatico ottimizzato che include Zona + Comune. Oppure inserisci un prompt personalizzato per Perplexity"></textarea>
                <small class="text-muted">Se lasciato vuoto, viene generato automaticamente un prompt che include: "Trova POI nel Comune di [Comune], nella zona [Zona]"</small>
              </div>
              <div id="progressContainer" style="display: none;">
                <div class="progress mb-3">
                  <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progressMessage" class="text-muted"></p>
              </div>
            </div>
            <div class="modal-footer border-secondary">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
              <button type="button" class="btn btn-primary" onclick="startPOIGeneration('${zoneId}')">Avvia Generazione</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
      });

      // Inizializza tooltip Bootstrap dopo che il modale √® stato mostrato
      modal.addEventListener('shown.bs.modal', () => {
        // Inizializza tooltip se Bootstrap √® disponibile
        if (typeof bootstrap !== 'undefined') {
          const tooltipTriggerList = [].slice.call(modal.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
      });
    }

    async function startPOIGeneration(zoneId) {
      const municipality = document.getElementById('municipality').value;
      const type = document.getElementById('poiType').value;
      const customPrompt = document.getElementById('customPrompt').value.trim() || null;
      
      // Validazione comune
      if (!municipality) {
        alert('‚ö†Ô∏è Seleziona un Comune prima di avviare la generazione');
        return;
      }
      
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressMessage = document.getElementById('progressMessage');
      
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressMessage.textContent = 'Avvio generazione...';

      try {
        const response = await fetch(`/admin/zones/${zoneId}/generate-pois`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ type, customPrompt, municipality })
        });

        const result = await response.json();

        if (result.success) {
          progressBar.style.width = '100%';
          progressMessage.textContent = 'Generazione completata!';
          
          // Salva risultati in sessionStorage per la pagina di revisione
          sessionStorage.setItem('poiGenerationResults', JSON.stringify({
            zoneId: zoneId,
            results: result.results
          }));

          // Redirect alla pagina di revisione
          setTimeout(() => {
            window.location.href = `/admin/zones/${zoneId}/review-pois`;
          }, 1000);
        } else {
          alert('‚ùå Errore: ' + result.message);
        }
      } catch (error) {
        console.error('Errore:', error);
        alert('‚ùå Errore durante la generazione POI');
      }
    }
  </script>
</body>
</html>