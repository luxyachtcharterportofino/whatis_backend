<%- include('partials/head') %>
<body class="bg-dark text-light">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-black shadow-sm px-4">
    <a class="navbar-brand text-light" href="/admin/dashboard" aria-label="Whatis dashboard" style="font-size: 1.5rem; font-weight: bold;">
        Whatis Explorer
    </a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link text-light" href="/admin/dashboard">Dashboard</a>
      <a class="nav-link text-light" href="/admin/zones">Zone</a>
      <a class="nav-link text-light" href="/admin/pois">POI</a>
      <a class="nav-link text-info" href="/admin/tour-guides">Guide Turistiche</a>
      <a class="nav-link text-light" href="/admin/map">Cartina</a>
    </div>
  </nav>
  
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="text-info mb-0">üë• Guide Turistiche - <%= zone.name %></h4>
      <a href="/admin/tour-guides" class="btn btn-secondary">‚Üê Torna alla lista</a>
    </div>

    <div class="alert alert-info mb-4" role="alert">
      <h6 class="alert-heading">‚ÑπÔ∏è Istruzioni</h6>
      <p class="mb-2">Aggiungi le agenzie di guide turistiche autorizzate per questa zona. I dati inseriti qui saranno visibili nell'app mobile.</p>
      <p class="mb-0"><strong>Campi obbligatori:</strong> Nome e Sito Web. Email e Telefono sono opzionali.</p>
    </div>

    <form id="tourGuidesForm">
      <div id="guidesContainer">
        <!-- Le guide esistenti saranno aggiunte qui via JavaScript -->
      </div>

      <div class="mt-3">
        <button type="button" class="btn btn-success" onclick="addGuide()">‚ûï Aggiungi Guida</button>
        <button type="submit" class="btn btn-primary">üíæ Salva Guide</button>
        <a href="/admin/tour-guides" class="btn btn-secondary">Annulla</a>
      </div>
    </form>
  </div>

  <script>
    const zoneId = '<%= zone._id %>';
    const existingGuides = <%- JSON.stringify(zone.tourGuides || []) %>;

    // Inizializza con guide esistenti
    document.addEventListener('DOMContentLoaded', function() {
      if (existingGuides.length > 0) {
        existingGuides.forEach(guide => {
          addGuide(guide);
        });
      } else {
        // Se non ci sono guide esistenti, aggiungi un campo vuoto
        addGuide();
      }
    });

    function addGuide(guideData = null) {
      const container = document.getElementById('guidesContainer');
      const guideIndex = container.children.length;
      
      const guideCard = document.createElement('div');
      guideCard.className = 'card bg-secondary mb-3';
      guideCard.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="card-title text-light mb-0">Guida #${guideIndex + 1}</h6>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeGuide(this)">üóëÔ∏è Rimuovi</button>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label text-light">Nome <span class="text-danger">*</span></label>
              <input type="text" class="form-control bg-dark text-light border-secondary" 
                     name="guides[${guideIndex}][name]" 
                     value="${guideData ? (guideData.name || '') : ''}" 
                     required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label text-light">Sito Web <span class="text-danger">*</span></label>
              <input type="url" class="form-control bg-dark text-light border-secondary" 
                     name="guides[${guideIndex}][website]" 
                     value="${guideData ? (guideData.website || '') : ''}" 
                     placeholder="https://example.com"
                     required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label text-light">Telefono</label>
              <input type="tel" class="form-control bg-dark text-light border-secondary" 
                     name="guides[${guideIndex}][phone]" 
                     value="${guideData ? (guideData.phone || '') : ''}"
                     placeholder="+39 123 456 7890">
            </div>
            
            <div class="col-md-6">
              <label class="form-label text-light">Email</label>
              <input type="email" class="form-control bg-dark text-light border-secondary" 
                     name="guides[${guideIndex}][email]" 
                     value="${guideData ? (guideData.email || '') : ''}"
                     placeholder="info@example.com">
            </div>
            
            <div class="col-12">
              <label class="form-label text-light">Descrizione</label>
              <textarea class="form-control bg-dark text-light border-secondary" 
                        name="guides[${guideIndex}][description]" 
                        rows="2"
                        placeholder="Breve descrizione dell'agenzia...">${guideData ? (guideData.description || '') : ''}</textarea>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(guideCard);
      updateGuideNumbers();
    }

    function removeGuide(button) {
      const container = document.getElementById('guidesContainer');
      if (container.children.length <= 1) {
        alert('Deve esserci almeno una guida. Se vuoi rimuoverla, lascia i campi vuoti e salva.');
        return;
      }
      button.closest('.card').remove();
      updateGuideNumbers();
    }

    function updateGuideNumbers() {
      const container = document.getElementById('guidesContainer');
      Array.from(container.children).forEach((card, index) => {
        const title = card.querySelector('.card-title');
        if (title) {
          title.textContent = `Guida #${index + 1}`;
        }
      });
    }

    document.getElementById('tourGuidesForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const guides = [];
      
      // Raccogli tutti i dati delle guide
      const guideData = {};
      for (const [key, value] of formData.entries()) {
        const match = key.match(/guides\[(\d+)\]\[(\w+)\]/);
        if (match) {
          const index = match[1];
          const field = match[2];
          if (!guideData[index]) {
            guideData[index] = {};
          }
          guideData[index][field] = value;
        }
      }
      
      // Converti in array e filtra guide vuote
      Object.values(guideData).forEach(guide => {
        if (guide.name && guide.website) {
          guides.push({
            name: guide.name.trim(),
            website: guide.website.trim(),
            description: (guide.description || '').trim(),
            phone: (guide.phone || '').trim(),
            email: (guide.email || '').trim()
          });
        }
      });
      
      try {
        const response = await fetch(`/admin/tour-guides/${zoneId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ tourGuides: guides })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Guide turistiche salvate con successo!');
          window.location.href = '/admin/tour-guides';
        } else {
          alert('‚ùå Errore: ' + (result.message || 'Errore sconosciuto'));
        }
      } catch (error) {
        console.error('Errore:', error);
        alert('‚ùå Errore durante il salvataggio: ' + error.message);
      }
    });
  </script>

  <%- include('partials/footer') %>
</body>
</html>

