<%- include('partials/head') %>
<script src="/js/poi-display-utils.js"></script>
<script src="/js/icon-library.js"></script>

<%
// Helper functions for EJS template
function getCategoryLabel(category) {
  const labels = {
    'monument': { text: 'Monumento', color: 'warning', icon: 'üèõÔ∏è' },
    'church': { text: 'Chiesa', color: 'primary', icon: '‚õ™' },
    'marina': { text: 'Marina', color: 'primary', icon: '‚öì' },
    'beach': { text: 'Spiaggia', color: 'success', icon: 'üèñÔ∏è' },
    'biological': { text: 'Biologico', color: 'success', icon: 'üåø' },
    'wreck': { text: 'Relitto', color: 'dark', icon: 'üö¢' },
    'viewpoint': { text: 'Punto panoramico', color: 'info', icon: 'üì∏' },
    'village': { text: 'Villaggio', color: 'secondary', icon: 'üèòÔ∏è' },
    'event': { text: 'Evento', color: 'danger', icon: 'üéâ' },
    'restaurant': { text: 'Ristorante', color: 'danger', icon: 'üçΩÔ∏è' },
    'hotel': { text: 'Hotel', color: 'secondary', icon: 'üè®' },
    'museum': { text: 'Museo', color: 'info', icon: 'üñºÔ∏è' },
    'park': { text: 'Parco', color: 'success', icon: 'üå≥' },
    'harbor': { text: 'Porto', color: 'primary', icon: 'üö¢' },
    'lighthouse': { text: 'Faro', color: 'warning', icon: 'üóº' },
    'cave': { text: 'Grotta', color: 'secondary', icon: '‚õ∞Ô∏è' },
    'mountain': { text: 'Montagna', color: 'dark', icon: 'üèîÔ∏è' },
    'lake': { text: 'Lago', color: 'info', icon: 'üèûÔ∏è' },
    'river': { text: 'Fiume', color: 'info', icon: 'üåä' },
    'other': { text: 'Altro', color: 'dark', icon: 'üìç' }
  };
  return labels[category] || labels.other;
}

function getSourceLabel(source) {
  const labels = {
    'manual': { text: 'Manuale', color: 'secondary', icon: '‚úã' },
    'AI': { text: 'AI', color: 'success', icon: 'üß†' },
    'ai': { text: 'AI', color: 'success', icon: 'üß†' },
    'osm': { text: 'OSM', color: 'info', icon: 'üó∫Ô∏è' },
    'wikipedia': { text: 'Wikipedia', color: 'warning', icon: 'üìö' },
    'internet': { text: 'Internet', color: 'primary', icon: 'üåê' }
  };
  return labels[source] || labels.manual;
}
%>

<style>
  .poi-edit-form {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
  }
  
  .form-label {
    color: #17a2b8;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .form-control, .form-select {
    background-color: #2d3748;
    border: 1px solid #4a5568;
    color: #e2e8f0;
    border-radius: 8px;
  }
  
  .form-control:focus, .form-select:focus {
    background-color: #2d3748;
    border-color: #17a2b8;
    color: #e2e8f0;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
  }
  
  .form-control::placeholder {
    color: #a0aec0;
  }
  
  .btn-save {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }
  
  .btn-back {
    background: linear-gradient(135deg, #6c757d, #495057);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
  }
  
  .poi-header {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    color: white;
  }
  
  .category-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-left: 10px;
  }
  
  .section-header {
    color: #17a2b8;
    font-weight: 600;
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #17a2b8;
  }
  
  .coordinate-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .textarea-large {
    min-height: 120px;
  }
  
  /* Icon Selector Styles */
  .icon-selector-container {
    background-color: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .current-icon-display {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .icon-preview-large {
    font-size: 48px;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 8px;
    display: inline-block;
    min-width: 70px;
    text-align: center;
  }
  
  .icon-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .icon-modal-content {
    background: #1a1a1a;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #17a2b8;
  }
  
  .icon-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 2px solid #17a2b8;
  }
  
  .icon-modal-header h5 {
    margin: 0;
    color: #17a2b8;
  }
  
  .btn-close-custom {
    background: none;
    border: none;
    color: #e2e8f0;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
  }
  
  .btn-close-custom:hover {
    color: #17a2b8;
  }
  
  .icon-modal-body {
    padding: 1.5rem;
  }
  
  .icon-category-group {
    margin-bottom: 1.5rem;
  }
  
  .icon-category-title {
    color: #17a2b8;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 14px;
  }
  
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 8px;
  }
  
  .icon-option {
    font-size: 32px;
    padding: 10px;
    text-align: center;
    background: #2d3748;
    border: 2px solid #4a5568;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .icon-option:hover {
    background: #17a2b8;
    border-color: #17a2b8;
    transform: scale(1.1);
  }
  
  .icon-option.selected {
    background: #28a745;
    border-color: #28a745;
  }
</style>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-black shadow-sm px-4">
  <a class="navbar-brand" href="/admin/dashboard" aria-label="Whatis dashboard">
        <img
          src="/images/whatis-logo-white.svg"
          alt="Whatis Explorer"
          style="height: 80px; width: auto; filter: drop-shadow(0 2px 6px rgba(255, 255, 255, 0.4));"
        />
  </a>
  <div class="navbar-nav ms-auto">
    <a class="nav-link text-light" href="/admin/dashboard">Dashboard</a>
    <a class="nav-link text-light" href="/admin/zones">Zone</a>
    <a class="nav-link text-light" href="/admin/pois">POI</a>
    <a class="nav-link text-light" href="/admin/map">Cartina</a>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
          <!-- Header -->
      <div class="poi-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h2 class="mb-0">‚úèÔ∏è Modifica POI</h2>
            <p class="mb-0 mt-2">Modifica le informazioni del punto di interesse</p>
            <% if (poi.isDefinitive) { %>
            <div class="alert alert-info mt-3 mb-0" style="background-color: rgba(23, 162, 184, 0.2); border: 1px solid #17a2b8;">
              <small>
                <strong>‚ÑπÔ∏è POI Definitivo:</strong> Questo POI √® nel database scaricabile dai turisti. 
                Puoi modificarlo o eliminarlo, e le modifiche verranno salvate nel database definitivo.
              </small>
            </div>
            <% } %>
          </div>

        </div>
      </div>

      <!-- Edit Form -->
      <div class="poi-edit-form">
        <form id="poiEditForm">
          <!-- Basic Information -->
          <div class="section-header">üìù Informazioni Base</div>
          
                    <div class="mb-3">
            <label for="name" class="form-label">Nome POI *</label>
            <input type="text" class="form-control" id="name" name="name" value="<%= poi.name %>" required>
          </div>
          
          <!-- Photo Management -->
          <div class="section-header">üì∏ Gestione Foto</div>
          
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Foto Attuale</label>
              <div class="current-photo-display">
                <% if (poi.imageUrl && poi.imageUrl.trim() !== '') { %>
                  <div class="photo-preview mb-3" id="photoPreview">
                    <img src="<%= poi.imageUrl %><%= typeof cacheBust !== 'undefined' && cacheBust ? ('?v=' + cacheBust) : '' %>" alt="<%= poi.name %>" class="img-fluid rounded" style="max-height: 200px; max-width: 300px; background: #f0f0f0;" onerror="console.error('‚ùå Errore caricamento immagine:', this.src); this.style.display='none'; document.getElementById('photoPreview').innerHTML='<div class=\\'text-center p-4 border border-dashed border-danger rounded bg-danger bg-opacity-10\\'><div class=\\'text-danger mb-2\\' style=\\'font-size: 48px;\\'>üì∑</div><p class=\\'text-danger mb-0 fw-bold\\'>Errore caricamento foto</p><p class=\\'text-muted mt-2\\'>Path: <%= poi.imageUrl %></p></div>';">
                    <div class="mt-2">
                      <small class="text-muted">Foto attuale: <%= poi.imageUrl %></small>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-light me-2" id="rotateExistingLeft">üîÑ Ruota -90¬∞</button>
                  <button type="button" class="btn btn-sm btn-outline-light me-2" id="rotateExistingRight">üîÅ Ruota +90¬∞</button>
                  <button type="button" class="btn btn-sm btn-outline-info" id="checkLicenseBtn" onclick="checkPhotoLicense('<%= poi._id %>')">üîç Verifica Licenza</button>
                  <script>
                    console.log('üì∏ Tentativo di caricare foto per POI:', '<%= poi.name %>');
                    console.log('üì∏ Path:', '<%= poi.imageUrl %>');
                  </script>
                <% } else { %>
                  <div class="no-photo-display mb-3">
                    <div class="text-center p-4 border border-dashed border-warning rounded">
                      <div class="text-warning mb-2" style="font-size: 48px;">üìç</div>
                      <p class="text-warning mb-0">Nessuna foto caricata</p>
                    </div>
                  </div>
                <% } %>
              </div>
              
              <!-- License Status Display -->
              <% if (poi.imageUrl && poi.imageUrl.trim() !== '') { %>
                <div class="license-status-section mb-3 p-3 rounded" style="background-color: #2d3748; border: 1px solid #4a5568;">
                  <label class="form-label mb-2">üìú Stato Licenza Foto</label>
                  <% 
                    const licenseStatus = poi.imageLicenseStatus || {};
                    const status = licenseStatus.status || 'not_checked';
                    const statusColors = {
                      'free': 'success',
                      'needs_attribution': 'warning',
                      'needs_replacement': 'danger',
                      'unknown': 'info',
                      'not_checked': 'secondary'
                    };
                    const statusIcons = {
                      'free': '‚úÖ',
                      'needs_attribution': '‚ö†Ô∏è',
                      'needs_replacement': 'üö´',
                      'unknown': '‚ùì',
                      'not_checked': '‚è≥'
                    };
                    const statusTexts = {
                      'free': 'Libera',
                      'needs_attribution': 'Richiede Attribuzione',
                      'needs_replacement': 'Da Sostituire',
                      'unknown': 'Sconosciuta',
                      'not_checked': 'Non Verificata'
                    };
                    const statusColor = statusColors[status] || 'secondary';
                    const statusIcon = statusIcons[status] || '‚ùì';
                    const statusText = statusTexts[status] || 'Non Verificata';
                  %>
                  <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="badge bg-<%= statusColor %>" style="font-size: 1rem; padding: 8px 12px;">
                      <%= statusIcon %> <%= statusText %>
                    </span>
                    <% if (licenseStatus.source) { %>
                      <small class="text-muted">Fonte: <%= licenseStatus.source %></small>
                    <% } %>
                    <% if (licenseStatus.checkedAt) { %>
                      <small class="text-muted">Verificata: <%= new Date(licenseStatus.checkedAt).toLocaleDateString('it-IT') %></small>
                    <% } %>
                  </div>
                  
                  <% if (licenseStatus.license) { %>
                    <div class="mb-2">
                      <small class="text-muted"><strong>Licenza:</strong> <%= licenseStatus.license %></small>
                    </div>
                  <% } %>
                  
                  <% if (licenseStatus.author) { %>
                    <div class="mb-2">
                      <small class="text-muted"><strong>Autore:</strong> <%= licenseStatus.author %></small>
                    </div>
                  <% } %>
                  
                  <% if (licenseStatus.notes) { %>
                    <div class="mb-3">
                      <small class="text-muted"><%= licenseStatus.notes %></small>
                    </div>
                  <% } %>
                  
                  <!-- Attribution Field -->
                  <div class="mb-2">
                    <label for="photoAttribution" class="form-label">üìù Attribuzione Foto</label>
                    <textarea 
                      class="form-control" 
                      id="photoAttribution" 
                      name="photoAttribution" 
                      rows="2" 
                      placeholder="Es: Photo by John Doe on Unsplash"
                    ><%= licenseStatus.attribution || '' %></textarea>
                    <div class="form-text text-muted">
                      Testo di attribuzione da mostrare con la foto. Compilato automaticamente quando possibile.
                    </div>
                  </div>
                </div>
              <% } %>
              
              <div class="photo-upload-section">
                <label for="photoUpload" class="form-label">Carica Nuova Foto</label>
                <input type="file" class="form-control" id="photoUpload" name="photo" accept="image/*">
                <div class="form-text text-muted">Carica una foto del POI (max 5MB, verr√† ridimensionata automaticamente)</div>
                <input type="hidden" id="rotateDegrees" name="rotateDegrees" value="0">
                <div id="newPhotoPreview" class="mt-3" style="display:none;">
                  <img id="newPhotoPreviewImg" class="img-fluid rounded" style="max-height: 240px; max-width: 100%; background:#111;" />
                  <div class="mt-2 d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-light" id="rotateLeftBtn">üîÑ Ruota -90¬∞</button>
                    <button type="button" class="btn btn-sm btn-outline-light" id="rotateRightBtn">üîÅ Ruota +90¬∞</button>
                    <small class="text-muted ms-2">L'orientamento sar√† applicato al salvataggio.</small>
                  </div>
                </div>
              </div>
              
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="source" class="form-label">Fonte</label>
              <select class="form-select" id="source" name="source">
                <option value="manual" <%= poi.source === 'manual' ? 'selected' : '' %>>‚úã Manuale</option>
                <option value="ai" <%= poi.source === 'ai' ? 'selected' : '' %>>ü§ñ AI</option>
                <option value="osm" <%= poi.source === 'osm' ? 'selected' : '' %>>üåê Open Data</option>
                <option value="wikipedia" <%= poi.source === 'wikipedia' ? 'selected' : '' %>>üìö Wikipedia</option>
                <option value="internet" <%= poi.source === 'internet' ? 'selected' : '' %>>üîó Internet</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="zone" class="form-label">Zona</label>
              <input type="text" class="form-control" id="zone" value="<%= poi.zone ? poi.zone.name : 'N/A' %>" readonly>
            </div>
          </div>

          <!-- Coordinates -->
          <div class="section-header">üìç Coordinate</div>
          
          <div class="mb-3">
            <label class="form-label">üó∫Ô∏è Mappa per Modificare Posizione</label>
            <div class="alert alert-info mb-2">
              <small>üí° Trascina il pin rosso sulla mappa per spostare il POI nella posizione corretta</small>
            </div>
            <div id="poi-edit-map" style="height: 400px; width: 100%; border-radius: 8px; border: 2px solid #17a2b8; margin-bottom: 15px;"></div>
          </div>
          
          <div class="coordinate-inputs mb-3">
            <div>
              <label for="lat" class="form-label">Latitudine *</label>
              <input type="number" class="form-control" id="lat" name="lat" value="<%= poi.lat %>" step="any" lang="en" required>
              <small class="form-text text-muted">Usa il punto (.) come separatore decimale</small>
            </div>
            <div>
              <label for="lng" class="form-label">Longitudine *</label>
              <input type="number" class="form-control" id="lng" name="lng" value="<%= poi.lng %>" step="any" lang="en" required>
              <small class="form-text text-muted">Usa il punto (.) come separatore decimale</small>
            </div>
          </div>

          <!-- Content -->
          <div class="section-header">üìñ Contenuto</div>
          
          <div class="mb-3">
            <label for="description" class="form-label">Descrizione Base</label>
            <textarea class="form-control textarea-large" id="description" name="description" placeholder="Inserisci una descrizione del POI..." style="min-height: 200px; resize: vertical;"><%= poi.description || '' %></textarea>
          </div>



          <!-- Action Buttons -->
          <div class="d-flex gap-3 mt-4">
            <button type="submit" class="btn btn-save text-white">
              üíæ Salva modifiche
            </button>
            <% if (!poi.isDefinitive) { %>
            <button type="button" class="btn btn-success text-white" id="makeDefinitiveBtn" onclick="makePOIDefinitive('<%= poi._id %>')" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; border-radius: 8px; padding: 12px 24px; font-weight: 600; transition: all 0.3s ease;">
              ‚úÖ Rendi Definitivo
            </button>
            <% } else { %>
            <span class="badge bg-success align-self-center" style="padding: 12px 24px; font-size: 1rem;">
              ‚úÖ POI Definitivo - Scaricabile dai turisti
            </span>
            <% } %>
            <a href="/admin/pois" class="btn btn-back text-white text-decoration-none">
              üîô Torna alla lista
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- üåç LEAFLET MAP -->
<!-- ============================= -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ============================= -->
<!-- üß± BOOTSTRAP JS -->
<!-- ============================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Dati POI per JavaScript
  const poiData = {
    imageUrl: '<%= poi.imageUrl || "" %>',
    customIcon: '<%= poi.customIcon || "" %>',
    category: '<%= poi.category || "other" %>',
    updatedAt: '<%= poi.updatedAt ? new Date(poi.updatedAt).getTime() : Date.now() %>'
  };
  
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Inizializza mappa per modificare coordinate
    let editMap = null;
    let editMarker = null;
    
    const latInput = document.getElementById('lat');
    const lngInput = document.getElementById('lng');
    const mapDiv = document.getElementById('poi-edit-map');
    
    // Funzione per convertire virgola in punto (per coordinate)
    function normalizeCoordinate(value) {
      if (typeof value === 'string') {
        return value.replace(',', '.');
      }
      return value;
    }
    
    // Normalizza i valori iniziali
    if (latInput) {
      latInput.value = normalizeCoordinate(latInput.value);
    }
    if (lngInput) {
      lngInput.value = normalizeCoordinate(lngInput.value);
    }
    
    // Listener per convertire virgole in punti quando l'utente digita
    if (latInput) {
      latInput.addEventListener('input', function() {
        this.value = normalizeCoordinate(this.value);
      });
    }
    if (lngInput) {
      lngInput.addEventListener('input', function() {
        this.value = normalizeCoordinate(this.value);
      });
    }
    
    if (mapDiv && latInput && lngInput) {
      const initialLat = parseFloat(normalizeCoordinate(latInput.value)) || 44.3;
      const initialLng = parseFloat(normalizeCoordinate(lngInput.value)) || 9.2;
      
      // Inizializza mappa
      editMap = L.map('poi-edit-map').setView([initialLat, initialLng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(editMap);
      
      // Crea marker draggable con foto/icona del POI (come nella mappa principale)
      let markerHTML = '';
      let markerClass = 'poi-marker-icon';
      const cacheVer = poiData.updatedAt;
      const displayImageUrl = poiData.imageUrl && poiData.imageUrl.trim() !== '';
      const imageUrlWithCache = displayImageUrl ? `${poiData.imageUrl}?v=${cacheVer}` : '';
      
      if (imageUrlWithCache) {
        // Use POI photo with circular shape (come nella mappa principale)
        markerHTML = `
          <div class="poi-photo-marker" style="background-image: url('${imageUrlWithCache}'); background-size: cover; background-position: center; border: 3px solid #ff6b6b; border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 3px 8px rgba(0,0,0,0.4); transition: all 0.3s ease; cursor: move;">
          </div>
        `;
        markerClass = 'poi-photo-marker';
      } else {
        // Use icon based on category or custom icon
        const categoryIcons = {
          'beach': 'üèñÔ∏è',
          'church': '‚õ™',
          'monument': 'üèõÔ∏è',
          'museum': 'üñºÔ∏è',
          'restaurant': 'üçΩÔ∏è',
          'hotel': 'üè®',
          'marina': '‚öì',
          'park': 'üå≥',
          'lighthouse': 'üóº',
          'wreck': 'üö¢',
          'viewpoint': 'üëÅÔ∏è',
          'biological': 'üåø'
        };
        const categoryIcon = poiData.customIcon && poiData.customIcon.trim() !== '' 
          ? poiData.customIcon 
          : (categoryIcons[poiData.category] || 'üìç');
        
        markerHTML = `
          <div class="poi-red-pin" style="font-size: 40px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 3px solid #ff6b6b; border-radius: 50%; background: rgba(255, 255, 255, 0.9); box-shadow: 0 3px 8px rgba(0,0,0,0.4); cursor: move;" title="Trascina per spostare il POI">
            ${categoryIcon}
          </div>
        `;
      }
      
      editMarker = L.marker([initialLat, initialLng], {
        draggable: true,
        icon: L.divIcon({
          className: markerClass,
          html: markerHTML,
          iconSize: [50, 50],
          iconAnchor: [25, 25]
        })
      }).addTo(editMap);
      
      // Popup informativo
      editMarker.bindPopup('<strong>Trascina il marker per spostare il POI</strong><br>Le coordinate verranno aggiornate automaticamente').openPopup();
      
      // Aggiorna coordinate quando il marker viene trascinato
      editMarker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        latInput.value = pos.lat.toFixed(6);
        lngInput.value = pos.lng.toFixed(6);
      });
      
      // Aggiorna marker quando si modificano manualmente le coordinate
      function updateMarkerFromInputs() {
        const lat = parseFloat(normalizeCoordinate(latInput.value));
        const lng = parseFloat(normalizeCoordinate(lngInput.value));
        
        if (!isNaN(lat) && !isNaN(lng) && editMarker && editMap) {
          editMarker.setLatLng([lat, lng]);
          editMap.setView([lat, lng], editMap.getZoom());
        }
      }
      
      latInput.addEventListener('change', updateMarkerFromInputs);
      lngInput.addEventListener('change', updateMarkerFromInputs);
      
      // Click sulla mappa per spostare il marker
      editMap.on('click', function(e) {
        const clickLat = e.latlng.lat;
        const clickLng = e.latlng.lng;
        editMarker.setLatLng([clickLat, clickLng]);
        latInput.value = clickLat.toFixed(6);
        lngInput.value = clickLng.toFixed(6);
      });
    }
    
    const poiEditForm = document.getElementById('poiEditForm');
    if (!poiEditForm) {
      console.error('‚ùå Form poiEditForm not found');
      return;
    }
    
    // Client-side rotation preview handlers
    let currentRotation = 0;
    const fileInput = document.getElementById('photoUpload');
    const previewWrap = document.getElementById('newPhotoPreview');
    const previewImg = document.getElementById('newPhotoPreviewImg');
    const rotateField = document.getElementById('rotateDegrees');
    const rotateLeftBtn = document.getElementById('rotateLeftBtn');
    const rotateRightBtn = document.getElementById('rotateRightBtn');

    function updatePreviewRotation() {
      if (previewImg) previewImg.style.transform = `rotate(${currentRotation}deg)`;
      if (rotateField) rotateField.value = ((currentRotation % 360) + 360) % 360; // 0..359
    }

    if (fileInput) {
      fileInput.addEventListener('change', () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          previewImg.src = ev.target.result;
          previewWrap.style.display = 'block';
          currentRotation = 0;
          updatePreviewRotation();
        };
        reader.readAsDataURL(file);
      });
    }

    if (rotateLeftBtn) rotateLeftBtn.addEventListener('click', () => { currentRotation -= 90; updatePreviewRotation(); });
    if (rotateRightBtn) rotateRightBtn.addEventListener('click', () => { currentRotation += 90; updatePreviewRotation(); });
    
    // Rotazione immagine gi√† salvata (POST server, poi reload)
    async function rotateExisting(deg) {
      try {
        const resp = await fetch('/admin/poi/rotate/<%= poi._id %>', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ rotateDegrees: String(deg) })
        });
        // Forziamo reload pagina (server fa comunque redirect)
        window.location.href = '/admin/poi/edit/<%= poi._id %>?rotated=1';
      } catch (err) {
        alert('‚ùå Errore rotazione immagine');
      }
    }

    const rotateExistingLeftBtn = document.getElementById('rotateExistingLeft');
    const rotateExistingRightBtn = document.getElementById('rotateExistingRight');
    if (rotateExistingLeftBtn) rotateExistingLeftBtn.addEventListener('click', () => rotateExisting(-90));
    if (rotateExistingRightBtn) rotateExistingRightBtn.addEventListener('click', () => rotateExisting(90));
    
    // Funzione per verificare la licenza della foto
    window.checkPhotoLicense = async function(poiId) {
      const btn = document.getElementById('checkLicenseBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Verifica in corso...';
      }

      try {
        const response = await fetch(`/admin/pois/${poiId}/check-photo-license`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
          const licenseInfo = result.licenseInfo;
          
          // Aggiorna il campo attribuzione se generato automaticamente
          const attributionField = document.getElementById('photoAttribution');
          if (attributionField && licenseInfo.attribution) {
            attributionField.value = licenseInfo.attribution;
          }
          
          // Mostra messaggio e ricarica la pagina per vedere i nuovi dati
          alert(`‚úÖ Licenza verificata!\n\nStato: ${licenseInfo.status}\n${licenseInfo.source ? 'Fonte: ' + licenseInfo.source + '\n' : ''}${licenseInfo.attribution ? 'Attribuzione: ' + licenseInfo.attribution : ''}`);
          window.location.reload();
        } else {
          throw new Error(result.error || 'Errore durante la verifica');
        }
      } catch (error) {
        console.error('‚ùå Errore verifica licenza:', error);
        alert('‚ùå Errore durante la verifica della licenza: ' + error.message);
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üîç Verifica Licenza';
        }
      }
    };
    
    poiEditForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Create FormData to handle file uploads
    const formData = new FormData(e.target);
    
    // Force add lat/lng if missing (fix for FormData issue)
    const latField = document.getElementById('lat');
    const lngField = document.getElementById('lng');
    
    if (latField && latField.value) {
      formData.set('lat', latField.value);
    }
    if (lngField && lngField.value) {
      formData.set('lng', lngField.value);
    }
    
    // Aggiungi attribuzione foto se presente
    const attributionField = document.getElementById('photoAttribution');
    if (attributionField && attributionField.value) {
      formData.set('photoAttribution', attributionField.value);
    }
    
    try {
      const response = await fetch(`/admin/poi/update/<%= poi._id %>`, {
        method: 'POST',
        body: formData // Send FormData instead of JSON
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert('‚úÖ POI aggiornato con successo!');
        window.location.href = '/admin/pois';
      } else {
        alert(`‚ùå Errore: ${result.message}`);
      }
    } catch (error) {
      console.error('‚ùå Error updating POI:', error);
      alert('‚ùå Errore durante il salvataggio');
    }
  });
  
  // ===============================
  // üé® ICON SELECTOR FUNCTIONS
  // ===============================
  
  function openIconSelector() {
    const modal = document.getElementById('iconSelectorModal');
    const categoriesContainer = document.getElementById('iconCategories');
    const currentCategory = document.getElementById('category').value;
    
    // Popola le icone suggerite in base alla categoria
    const suggestedIcons = getSuggestedIcons(currentCategory);
    const allGroups = Object.entries(iconLibrary);
    
    let html = '<div class="mb-3"><h6 class="text-warning">‚≠ê Icone Suggerite per questa categoria:</h6><div class="icon-grid">';
    
    suggestedIcons.slice(0, 10).forEach(icon => {
      html += `<div class="icon-option" onclick="selectIcon('${icon}')">${icon}</div>`;
    });
    
    html += '</div></div><hr style="border-color: #4a5568;"><h6 class="text-info mb-3">üìö Tutte le Icone Disponibili:</h6>';
    
    allGroups.forEach(([key, group]) => {
      html += `
        <div class="icon-category-group">
          <div class="icon-category-title">${group.name}</div>
          <div class="icon-grid">
            ${group.icons.map(icon => `<div class="icon-option" onclick="selectIcon('${icon}')">${icon}</div>`).join('')}
          </div>
        </div>
      `;
    });
    
    categoriesContainer.innerHTML = html;
    modal.style.display = 'flex';
  }
  
  function closeIconSelector() {
    document.getElementById('iconSelectorModal').style.display = 'none';
  }
  
  function selectIcon(icon) {
    document.getElementById('customIcon').value = icon;
    document.getElementById('currentIconPreview').textContent = icon;
    closeIconSelector();
    console.log('‚úÖ Icona selezionata:', icon);
  }
  
  function resetToDefaultIcon() {
    document.getElementById('customIcon').value = '';
    const category = document.getElementById('category').value;
    const defaultIcon = getDefaultIconForCategory(category);
    document.getElementById('currentIconPreview').textContent = defaultIcon;
    console.log('‚úÖ Ripristinata icona predefinita:', defaultIcon);
  }
  
  function setCustomEmoji() {
    const customEmoji = document.getElementById('customEmojiInput').value.trim();
    if (customEmoji) {
      selectIcon(customEmoji);
      document.getElementById('customEmojiInput').value = '';
    }
  }
  
  function getDefaultIconForCategory(category) {
    const icons = {
      'monument': 'üèõÔ∏è',
      'church': '‚õ™',
      'marina': '‚öì',
      'beach': 'üèñÔ∏è',
      'biological': 'üåø',
      'wreck': 'üö¢',
      'viewpoint': 'üëÅÔ∏è',
      'village': 'üèòÔ∏è',
      'event': 'üéâ',
      'restaurant': 'üçΩÔ∏è',
      'hotel': 'üè®',
      'museum': 'üñºÔ∏è',
      'park': 'üå≥',
      'harbor': 'üö¢',
      'lighthouse': 'üóº',
      'cave': 'üï≥Ô∏è',
      'mountain': '‚õ∞Ô∏è',
      'lake': 'üèûÔ∏è',
      'river': 'üåä',
      'other': 'üìç'
    };
    return icons[category] || 'üìç';
  }
  
    // Aggiorna anteprima quando cambia categoria
    const categoryField = document.getElementById('category');
    if (categoryField) {
      categoryField.addEventListener('change', function() {
        const customIconValue = document.getElementById('customIcon').value;
        if (!customIconValue) {
          // Se non c'√® icona custom, mostra quella predefinita della nuova categoria
          const defaultIcon = getDefaultIconForCategory(this.value);
          document.getElementById('currentIconPreview').textContent = defaultIcon;
        }
      });
    }
    
    // Chiudi modale con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeIconSelector();
      }
    });
    
    // ===============================
    // üîÑ AUTO-RESIZE TEXTAREA
    // ===============================
    
    function autoResizeTextarea(textarea) {
      // Reset height to get correct scrollHeight
      textarea.style.height = 'auto';
      // Set height to scrollHeight (content height)
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    // Apply auto-resize to description textarea
    const descriptionTextarea = document.getElementById('description');
    if (descriptionTextarea) {
      // Auto-resize on page load
      autoResizeTextarea(descriptionTextarea);
      
      // Auto-resize on input
      descriptionTextarea.addEventListener('input', function() {
        autoResizeTextarea(this);
      });
    }
    
    // ===============================
    // ‚úÖ RENDI POI DEFINITIVO
    // ===============================
    window.makePOIDefinitive = async function(poiId) {
      if (!confirm('Sei sicuro di voler rendere questo POI definitivo?\n\nI POI definitivi sono:\n- Immodificabili sulla mappa principale\n- Scaricabili dai turisti sull\'app\n\nQuesta azione pu√≤ essere annullata modificando il POI.')) {
        return;
      }
      
      const btn = document.getElementById('makeDefinitiveBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Elaborazione...';
      }
      
      try {
        const response = await fetch(`/admin/poi/make-definitive/${poiId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Reindirizza alla tabella dei POI per vedere l'aggiornamento immediato
          // La tabella mostrer√† "Definitivo" e "Coordinate Confermate"
          // Preserva il filtro della zona se presente
          const zoneId = '<%= poi.zone ? (poi.zone._id || poi.zone) : "" %>';
          const redirectUrl = zoneId 
            ? `/admin/pois?zone_id=${zoneId}&message=POI reso definitivo con successo`
            : '/admin/pois?message=POI reso definitivo con successo';
          window.location.href = redirectUrl;
        } else {
          alert(`‚ùå Errore: ${result.message || 'Errore durante l\'operazione'}`);
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '‚úÖ Rendi Definitivo';
          }
        }
      } catch (error) {
        console.error('‚ùå Errore:', error);
        alert('‚ùå Errore durante l\'operazione: ' + error.message);
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '‚úÖ Rendi Definitivo';
        }
      }
    };
  }); // End DOMContentLoaded
</script>

</body>
</html>
