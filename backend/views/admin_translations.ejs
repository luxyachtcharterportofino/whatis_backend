<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç Gestione Traduzioni - Andaly Whatis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #1a1a1a; color: #e2e8f0; }
    .card { background-color: #2d3748; border: 1px solid #4a5568; }
    .table-dark { background-color: #2d3748; }
    .table-dark th, .table-dark td { border-color: #4a5568; }
    .navbar-dark { background-color: #000 !important; }
    .language-badge { font-size: 1.2em; margin: 2px; }
    .progress { background-color: #4a5568; }
    .btn-translate { margin: 2px; }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .status-complete { background-color: #28a745; }
    .status-partial { background-color: #ffc107; }
    .status-none { background-color: #dc3545; }
    .translation-preview { max-height: 100px; overflow-y: auto; font-size: 0.9em; }
    .batch-controls { background-color: #1a202c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-black shadow-sm px-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin/dashboard" aria-label="Whatis dashboard">
        <img
          src="/images/whatis-logo-white.svg"
          alt="Whatis Explorer"
          style="height: 80px; width: auto; filter: drop-shadow(0 2px 6px rgba(255, 255, 255, 0.4));"
        />
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link text-light" href="/admin/dashboard">Dashboard</a>
        <a class="nav-link text-light" href="/admin/zones">Zone</a>
        <a class="nav-link text-light" href="/admin/pois">POI</a>
        <a class="nav-link text-light" href="/admin/tour-guides">Guide Turistiche</a>
        <a class="nav-link text-light" href="/admin/map">Mappa</a>
        <a class="nav-link text-info active" href="/admin/translations">Traduzioni</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <h1 class="text-light mb-1">
          <i class="bi bi-globe-americas text-info"></i> Gestione Traduzioni POI
        </h1>
            <p class="text-muted mb-0">Gestisci le traduzioni multilingua per l'APP internazionale</p>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span id="providerBadge" class="badge rounded-pill bg-secondary" title="Provider traduzioni attivo">Provider: ‚Ä¶</span>
            <span id="missingBadge" class="badge rounded-pill bg-warning text-dark" title="Traduzioni mancanti nella zona selezionata">Mancanti: ‚Ä¶</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Batch Translation Controls -->
    <div class="batch-controls">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="text-light mb-3">
            <i class="bi bi-arrow-repeat text-warning"></i> Traduzione Batch
          </h5>
          <div class="row">
            <div class="col-md-12">
              <label class="form-label text-light">Zona:</label>
              <select class="form-select bg-dark text-light border-secondary" id="batchZone">
                <option value="">Tutte le zone</option>
              </select>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-warning btn-lg" onclick="startBatchTranslation()">
            <i class="bi bi-translate"></i> Traduci Tutto
          </button>
      </div>
      </div>
    </div>

    <!-- Translation Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h3 class="text-info" id="totalPOIs">-</h3>
            <p class="text-muted mb-0">POI Totali</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h3 class="text-success" id="completeTranslations">-</h3>
            <p class="text-muted mb-0">Traduzioni Complete</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h3 class="text-warning" id="partialTranslations">-</h3>
            <p class="text-muted mb-0">Traduzioni Parziali</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h3 class="text-danger" id="missingTranslations">-</h3>
            <p class="text-muted mb-0">Traduzioni Mancanti</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Overlay -->
    <div id="translationProgress" class="position-fixed top-0 start-0 w-100 h-100" 
         style="display:none; background: rgba(0,0,0,0.55); z-index: 1050;">
      <div class="position-absolute top-50 start-50 translate-middle" style="min-width: 420px;">
        <div class="card">
          <div class="card-body">
            <h5 class="mb-2 text-info"><i class="bi bi-translate"></i> Traduzione in corso‚Ä¶</h5>
            <div class="progress mb-2" style="height: 22px;">
              <div id="translationProgressBar" class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between small">
              <span id="translationProgressText" class="text-muted">Avvio‚Ä¶</span>
              <span id="translationProgressPct" class="text-info fw-bold">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Translation Table -->
    <div class="card">
      <div class="card-header bg-dark">
        <h5 class="mb-0 text-light">
          <i class="bi bi-table text-info"></i> Stato Traduzioni POI
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0">
            <thead>
              <tr>
                <th>POI</th>
                <th>Zona</th>
                <th>üá∫üá∏ EN</th>
                <th>üá´üá∑ FR</th>
                <th>üá™üá∏ ES</th>
                <th>üá©üá™ DE</th>
                <th>üá∑üá∫ RU</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="translationsTableBody">
              <tr>
                <td colspan="8" class="text-center text-muted">
                  <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Caricamento...</span>
                  </div>
                  Caricamento traduzioni...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Translation Editor Modal -->
    <div class="modal fade" id="translationModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light border-light">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-translate text-info"></i> Editor Traduzioni
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="translationModalContent">
              <!-- Content will be loaded dynamically -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            <button type="button" class="btn btn-success" onclick="saveTranslation()">
              <i class="bi bi-save"></i> Salva Traduzione
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Translation Management Script -->
  <script>
    let currentPOI = null;
    let currentLanguage = null;
    let translationsData = [];

    // Load page data
    document.addEventListener('DOMContentLoaded', function() {
      loadTranslationsData();
      loadZones();
    loadProviderBadge();
    });

    // Load translations data
    async function loadTranslationsData() {
      try {
        const response = await fetch('/pois?format=json');
        const pois = await response.json();
        
        translationsData = pois;
        renderTranslationsTable();
        updateStatistics();
        
      } catch (error) {
        console.error('Error loading translations data:', error);
        showAlert('Errore nel caricamento dei dati', 'error');
      }
    }

    // Load zones for batch translation and filtering
    async function loadZones() {
      try {
        const response = await fetch('/zones?format=json');
        const zones = await response.json();
        
        const batchSelect = document.getElementById('batchZone');
        
        // Clear existing options
        batchSelect.innerHTML = '<option value="">Tutte le zone</option>';
        
        zones.forEach(zone => {
          const batchOption = document.createElement('option');
          batchOption.value = zone._id;
          batchOption.textContent = zone.name;
          batchSelect.appendChild(batchOption);
        });
        
        // Add event listener for batch dropdown to filter table
        batchSelect.addEventListener('change', function() {
          const selectedZone = this.value || null;
          renderTranslationsTable(selectedZone);
          updateStatistics(selectedZone);
        });
        
      } catch (error) {
        console.error('Error loading zones:', error);
      }
    }

    // Render translations table
    function renderTranslationsTable(selectedZoneId = null) {
      const tbody = document.getElementById('translationsTableBody');
      tbody.innerHTML = '';

      // Filter POIs by selected zone if specified
      let poisToRender = translationsData;
      if (selectedZoneId) {
        poisToRender = translationsData.filter(poi => {
          // Handle both populated and non-populated zone references
          if (!poi.zone) return false;
          
          // Check if zone is a populated object
          if (typeof poi.zone === 'object' && poi.zone._id) {
            return poi.zone._id.toString() === selectedZoneId.toString();
          }
          
          // Check if zone is just an ObjectId string
          if (typeof poi.zone === 'string') {
            return poi.zone === selectedZoneId;
          }
          
          return false;
        });
        
        console.log(`Filtered ${poisToRender.length} POIs for zone ${selectedZoneId} out of ${translationsData.length} total`);
      }

      poisToRender.forEach(poi => {
        const row = document.createElement('tr');
        
        const translationStatus = getTranslationStatus(poi);
        
        // Get image URL or use red pin placeholder
        const poiImageUrl = poi.imageUrl || '/icons/red-pin.png';
        const imageUrl = poiImageUrl.startsWith('/') ? poiImageUrl : `/${poiImageUrl}`;
        
        row.innerHTML = `
          <td>
            <div class="d-flex align-items-center">
              <img src="${imageUrl}" 
                   alt="${poi.name}" 
                   class="me-2" 
                   style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid #4a5568;"
                   onerror="this.src='/icons/red-pin.png'">
              <div>
                <strong>${poi.name}</strong>
                <br><small class="text-muted">${poi.description?.substring(0, 50)}...</small>
              </div>
            </div>
          </td>
          <td>${poi.zone?.name || 'N/A'}</td>
          ${renderLanguageStatus(translationStatus, 'en')}
          ${renderLanguageStatus(translationStatus, 'fr')}
          ${renderLanguageStatus(translationStatus, 'es')}
          ${renderLanguageStatus(translationStatus, 'de')}
          ${renderLanguageStatus(translationStatus, 'ru')}
          <td>
            <button class="btn btn-sm btn-info" onclick="openTranslationEditor('${poi._id}')" title="Modifica traduzioni">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="translatePOI('${poi._id}')" title="Traduci automaticamente">
              <i class="bi bi-translate"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Get translation status for a POI (overall status across all languages)
    function getTranslationStatus(poi) {
      const languages = ['en', 'fr', 'es', 'de', 'ru'];
      let translatedLanguages = 0;
      let totalLanguages = 0;
      
      languages.forEach(lang => {
        const langContent = poi.multilingual?.[lang];
        totalLanguages++;
        
        if (langContent) {
          const name = (langContent.name || '').trim();
          const description = (langContent.description || '').trim();
          
          // Check if this language has BOTH name AND description translated
          // A language is only considered fully translated if both fields are present
          if (name && description) {
            translatedLanguages++;
          }
        }
      });
      
      // Return overall status based on how many languages are translated
      let overallStatus = 'none'; // Default: no translations
      
      if (translatedLanguages === 0) {
        overallStatus = 'none'; // None translated
      } else if (translatedLanguages === totalLanguages) {
        overallStatus = 'complete'; // All translated
      } else {
        overallStatus = 'partial'; // Some translated
      }
      
      // Return a consistent status for all languages (showing overall POI status)
      const status = {};
      languages.forEach(lang => {
        status[lang] = overallStatus;
      });
      
      return status;
    }

    // Render language status cell
    function renderLanguageStatus(status, lang) {
      let statusClass, statusText, textColor;
      
      if (status[lang] === 'complete') {
        statusClass = 'status-complete';
        statusText = 'Completa';
        textColor = 'text-success';
      } else if (status[lang] === 'partial') {
        statusClass = 'status-partial';
        statusText = 'Parziale';
        textColor = 'text-warning';
      } else {
        statusClass = 'status-none';
        statusText = 'Mancante';
        textColor = 'text-danger';
      }
      
      return `
        <td class="text-center">
          <span class="${statusClass}"></span>
          <small class="${textColor} fw-bold">${statusText}</small>
        </td>
      `;
    }

    // Update statistics
    function updateStatistics(selectedZoneId = null) {
      // Filter POIs if zone is selected
      let poisToCount = translationsData;
      if (selectedZoneId) {
        poisToCount = translationsData.filter(poi => {
          if (!poi.zone) return false;
          if (typeof poi.zone === 'object' && poi.zone._id) {
            return poi.zone._id.toString() === selectedZoneId.toString();
          }
          if (typeof poi.zone === 'string') {
            return poi.zone === selectedZoneId;
          }
          return false;
        });
      }
      
      const totalPOIs = poisToCount.length;
      let completeTranslations = 0;
      let partialTranslations = 0;
      let missingTranslations = 0;

      poisToCount.forEach(poi => {
        const status = getTranslationStatus(poi);
        const overallStatus = status['en']; // Get overall status (same for all languages)
        
        if (overallStatus === 'complete') {
          completeTranslations++;
        } else if (overallStatus === 'partial') {
          partialTranslations++;
        } else {
          missingTranslations++;
        }
      });

      document.getElementById('totalPOIs').textContent = totalPOIs;
      document.getElementById('completeTranslations').textContent = completeTranslations;
      document.getElementById('partialTranslations').textContent = partialTranslations;
      document.getElementById('missingTranslations').textContent = missingTranslations;

      // Update header missing badge
      const missingBadge = document.getElementById('missingBadge');
      if (missingBadge) missingBadge.textContent = `Mancanti: ${missingTranslations}`;
    }

    // Provider badge loader
    async function loadProviderBadge() {
      try {
        const resp = await fetch('/admin/translations/provider');
        const data = await resp.json();
        const badge = document.getElementById('providerBadge');
        if (!badge) return;
        if (data && data.success) {
          const p = (data.provider || '').toLowerCase();
          if (p === 'deepl') {
            badge.classList.remove('bg-secondary');
            badge.classList.add('bg-info');
            badge.textContent = 'Provider: DeepL';
          } else {
            badge.classList.remove('bg-info');
            badge.classList.add('bg-secondary');
            badge.textContent = 'Provider: Non configurato';
          }
        } else {
          badge.textContent = 'Provider: Non configurato';
        }
      } catch (_) {
        const badge = document.getElementById('providerBadge');
        if (badge) badge.textContent = 'Provider: Non configurato';
      }
    }

    // Open translation editor
    async function openTranslationEditor(poiId) {
      try {
        const poi = translationsData.find(p => p._id === poiId);
        if (!poi) return;

        currentPOI = poi;
        
        const content = `
          <div class="row">
            <div class="col-12 mb-3">
              <h6 class="text-info">POI: ${poi.name}</h6>
              <p class="text-muted">Modifica le traduzioni per questo POI</p>
            </div>
          </div>
          
          <div class="row">
            ${renderLanguageTabs(poi)}
          </div>
        `;
        
        document.getElementById('translationModalContent').innerHTML = content;
        const modal = new bootstrap.Modal(document.getElementById('translationModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error opening translation editor:', error);
        showAlert('Errore nell\'apertura dell\'editor', 'error');
      }
    }

    // Render language tabs
    function renderLanguageTabs(poi) {
      const languages = {
        'en': { name: 'English', flag: 'üá∫üá∏' },
        'fr': { name: 'Fran√ßais', flag: 'üá´üá∑' },
        'es': { name: 'Espa√±ol', flag: 'üá™üá∏' },
        'de': { name: 'Deutsch', flag: 'üá©üá™' },
        'ru': { name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' }
      };

      let tabsHTML = `
        <div class="col-12">
          <ul class="nav nav-tabs" id="languageTabs" role="tablist">
      `;

      Object.entries(languages).forEach(([code, info], index) => {
        tabsHTML += `
          <li class="nav-item" role="presentation">
            <button class="nav-link ${index === 0 ? 'active' : ''}" 
                    id="${code}-tab" data-bs-toggle="tab" 
                    data-bs-target="#${code}" type="button" role="tab">
              ${info.flag} ${info.name}
            </button>
          </li>
        `;
      });

      tabsHTML += `
          </ul>
          <div class="tab-content" id="languageTabContent">
      `;

      Object.entries(languages).forEach(([code, info], index) => {
        const langContent = poi.multilingual?.[code] || {};
        tabsHTML += `
          <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" id="${code}" role="tabpanel">
            <div class="row mt-3">
              <div class="col-12">
                <label class="form-label text-info">Nome ${info.name}</label>
                <input type="text" class="form-control bg-dark text-light border-secondary" 
                       id="${code}-name" value="${langContent.name || ''}" 
                       placeholder="Nome in ${info.name}">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <label class="form-label text-info">Descrizione ${info.name}</label>
                <textarea class="form-control bg-dark text-light border-secondary" 
                          id="${code}-description" rows="8" 
                          placeholder="Descrizione completa in ${info.name}">${langContent.description || ''}</textarea>
              </div>
            </div>
          </div>
        `;
      });

      tabsHTML += `
          </div>
        </div>
      `;

      return tabsHTML;
    }

    // Save translation
    async function saveTranslation() {
      if (!currentPOI) return;

      try {
        const languages = ['en', 'fr', 'es', 'de', 'ru'];
        const updates = {};

        languages.forEach(lang => {
          const name = document.getElementById(`${lang}-name`)?.value || '';
          const description = document.getElementById(`${lang}-description`)?.value || '';

          if (name || description) {
            updates[lang] = { name, description };
          }
        });

        const response = await fetch(`/translations/${currentPOI._id}/batch`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        if (response.ok) {
          showAlert('Traduzioni salvate con successo!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('translationModal')).hide();
          
          // Reload data and maintain zone filter
          await loadTranslationsData();
          // Re-apply zone filter after reload
          const currentZone = document.getElementById('batchZone').value;
          if (currentZone) {
            renderTranslationsTable(currentZone);
            updateStatistics(currentZone);
          }
        } else {
          throw new Error('Errore nel salvataggio');
        }

      } catch (error) {
        console.error('Error saving translation:', error);
        showAlert('Errore nel salvataggio delle traduzioni', 'error');
      }
    }

    // Translate POI automatically
    async function translatePOI(poiId) {
      try {
        const languages = ['en', 'fr', 'es', 'de', 'ru'];
        // progress UI
        showProgress('Traduzione POI in corso‚Ä¶', 0);
        const total = languages.length; let done = 0;
        
        for (const lang of languages) {
          const response = await fetch(`/translations/translate/${poiId}/${lang}`, {
            method: 'POST'
          });
          
          if (!response.ok) {
            console.error(`Error translating to ${lang}`);
          }
          done++;
          updateProgress(Math.round((done/total)*100), `Traduzione ${done}/${total}‚Ä¶`);
        }

        showAlert('Traduzione automatica completata!', 'success');
        hideProgress();
        // Reload data and maintain zone filter
        await loadTranslationsData();
        // Re-apply zone filter after reload
        const currentZone = document.getElementById('batchZone').value;
        if (currentZone) {
          renderTranslationsTable(currentZone);
          updateStatistics(currentZone);
        }

      } catch (error) {
        console.error('Error translating POI:', error);
        showAlert('Errore nella traduzione automatica', 'error');
        hideProgress();
      }
    }

    // Start batch translation - translates all POIs in selected zone to all languages
    async function startBatchTranslation() {
      const zoneId = document.getElementById('batchZone').value;
      
      try {
        let poiIds = translationsData.map(poi => poi._id);
        
        if (zoneId) {
          poiIds = poiIds.filter(poiId => {
            const poi = translationsData.find(p => p._id === poiId);
            return poi.zone._id === zoneId;
          });
        }

        if (poiIds.length === 0) {
          showAlert('Nessun POI trovato per la traduzione', 'warning');
          return;
        }

        // Translate all POIs to all languages
        const languages = ['en', 'fr', 'es', 'de', 'ru'];
        let totalSuccess = 0;
        let totalErrors = 0;
        const totalSteps = poiIds.length * languages.length;
        let done = 0;
        showProgress('Traduzione batch in corso‚Ä¶', 0);

        for (const poiId of poiIds) {
          for (const lang of languages) {
            try {
              const response = await fetch(`/translations/translate/${poiId}/${lang}`, {
                method: 'POST'
              });
              
              if (response.ok) {
                totalSuccess++;
              } else {
                totalErrors++;
              }
            } catch (error) {
              console.error(`Error translating POI ${poiId} to ${lang}:`, error);
              totalErrors++;
            }
            done++;
            updateProgress(Math.round((done/totalSteps)*100), `Tradotto ${done}/${totalSteps} elementi‚Ä¶`);
          }
        }

        showAlert(`Traduzione batch completata: ${totalSuccess} successi, ${totalErrors} errori`, 'success');
        hideProgress();
        
        // Reload data and maintain zone filter
        await loadTranslationsData();
        if (zoneId) {
          renderTranslationsTable(zoneId);
          updateStatistics(zoneId);
        }

      } catch (error) {
        console.error('Error batch translating:', error);
        showAlert('Errore nella traduzione batch', 'error');
        hideProgress();
      }
    }

    // Show alert
    function showAlert(message, type) {
      const alertClass = type === 'error' ? 'alert-danger' : 
                        type === 'warning' ? 'alert-warning' : 'alert-success';
      
      const alertHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Insert at top of container
      const container = document.querySelector('.container-fluid');
      container.insertAdjacentHTML('afterbegin', alertHTML);
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
          bootstrap.Alert.getOrCreateInstance(alert).close();
        }
      }, 5000);
    }

    // Progress helpers
    function showProgress(text, percent) {
      const overlay = document.getElementById('translationProgress');
      const bar = document.getElementById('translationProgressBar');
      const txt = document.getElementById('translationProgressText');
      const pct = document.getElementById('translationProgressPct');
      if (!overlay || !bar || !txt || !pct) return;
      overlay.style.display = 'block';
      txt.textContent = text || 'In corso‚Ä¶';
      bar.style.width = `${percent||0}%`;
      bar.setAttribute('aria-valuenow', percent||0);
      pct.textContent = `${percent||0}%`;
    }
    function updateProgress(percent, text) {
      const bar = document.getElementById('translationProgressBar');
      const txt = document.getElementById('translationProgressText');
      const pct = document.getElementById('translationProgressPct');
      if (!bar || !txt || !pct) return;
      if (typeof text === 'string') txt.textContent = text;
      bar.style.width = `${percent}%`;
      bar.setAttribute('aria-valuenow', percent);
      pct.textContent = `${percent}%`;
    }
    function hideProgress() {
      const overlay = document.getElementById('translationProgress');
      if (overlay) overlay.style.display = 'none';
    }
  </script>
</body>
</html>
